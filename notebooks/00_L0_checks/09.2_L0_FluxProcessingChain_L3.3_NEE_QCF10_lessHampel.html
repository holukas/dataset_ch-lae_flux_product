
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>BACKGROUND &#8212; CH-LAE Flux Product</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/00_L0_checks/09.2_L0_FluxProcessingChain_L3.3_NEE_QCF10_lessHampel';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">CH-LAE Flux Product</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../markdown.html">Markdown Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks.html">Content with notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../markdown-notebooks.html">Notebooks with MyST Markdown</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/holukas/dataset_ch-lae_flux_product" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/holukas/dataset_ch-lae_flux_product/issues/new?title=Issue%20on%20page%20%2Fnotebooks/00_L0_checks/09.2_L0_FluxProcessingChain_L3.3_NEE_QCF10_lessHampel.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/notebooks/00_L0_checks/09.2_L0_FluxProcessingChain_L3.3_NEE_QCF10_lessHampel.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>BACKGROUND</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#"><strong>BACKGROUND</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#general-settings"><strong>GENERAL SETTINGS</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-variable">Flux variable</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#site-location">Site location</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#daytime-nighttime">Daytime/nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-requirements">Quality requirements</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#imports"><strong>IMPORTS</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#docstring-for-fluxprocessingchain"><strong>DOCSTRING</strong> for <code class="docutils literal notranslate"><span class="pre">FluxProcessingChain</span></code></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-2-options"><strong>LOAD DATA</strong> (2 options)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-load-data-from-single-or-multiple-eddypro-fluxnet-output-files">Option 1: Load data from single or multiple EddyPro <em><em>fluxnet</em></em> output files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-load-data-from-parquet-file">Option 2: Load data from <code class="docutils literal notranslate"><span class="pre">parquet</span></code> file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-load-example-data">Option 3: Load example data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-restrict-data-to-time-range">(Optional) Restrict data to time range</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-data">Check data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#start-flux-processing-chain"><strong>START FLUX PROCESSING CHAIN</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-quality-flag-extension">Level-2: <strong>QUALITY FLAG EXTENSION</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-settings">User settings</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ssitc-tests-default-true">SSITC tests (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-base-variable-completeness-test-default-true">Flux base variable completeness test (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-correction-factor-test-default-true">Spectral correction factor test (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#signal-strength-test">Signal strength test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-data-screening-tests">Raw data screening tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#angle-of-attack-test-default-false">Angle-of-attack test (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steadiness-of-horizontal-wind-test-default-false">Steadiness of horizontal wind test (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run">Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-2">Finalize Level-2</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-2-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-2</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plots">Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reports">Reports</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-1-storage-correction">Level-3.1: <strong>STORAGE CORRECTION</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-3-1"><strong>Finalize Level-3.1</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-1-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-3.1</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#report">Report</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-analyze-highest-quality-flux-so-far">Optional: <strong>Analyze highest-quality flux</strong> (so far)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-2-outlier-detection">Level-3.2: <strong>OUTLIER DETECTION</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-time-series">Plot time series</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initiate-calculations">Initiate calculations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-absolute-limits">Outlier flag: <strong>Absolute limits</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-manual-flag">Outlier flag: <strong>Manual flag</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-hampel-filter-separate-for-daytime-and-nighttime">Outlier flag: <strong>Hampel filter</strong>, separate for daytime and nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-z-score-across-all-data">Outlier flag: <strong>z-score across all data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-hampel-filter">Outlier flag: <strong>Hampel filter</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-z-score-over-all-data-separate-for-daytime-and-nighttime">Outlier flag: <strong>z-score over all data</strong>, separate for daytime and nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-rolling-z-score-over-all-data">Outlier flag: <strong>Rolling z-score over all data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-standard-deviation-with-rolling-median-and-rolling-standard-deviation">Outlier flag: <strong>Local standard deviation</strong>, with rolling median and <em>rolling</em> standard deviation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-standard-deviation-with-rolling-median-and-constant-standard-deviation">Outlier flag: <strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-increments-z-score">Outlier flag: <strong>Increments z-score</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-outlier-factor-daytime-nighttime">Outlier flag: <strong>Local outlier factor</strong>, daytime/nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-outlier-factor">Outlier flag: <strong>Local outlier factor</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-absolute-limits-separate-for-daytime-and-nighttime-data">Outlier flag: <strong>Absolute limits</strong>, separate for daytime and nighttime data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-trim-nighttime-flux-data">Outlier flag: <strong>Trim nighttime flux data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-3-2-calculate-overall-quality-flag-so-far"><strong>Finalize Level-3.2</strong>: Calculate overall quality flag (so far)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-2-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-3.2</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-filtered-flux-after-level-3-2">Plot filtered flux after Level-3.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Reports</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-level-3-2-results-to-file">Save Level-3.2 results to file</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-3-ustar-filtering">Level-3.3: <strong>USTAR FILTERING</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-3-3-caculate-overall-final-quality-flag"><strong>Finalize Level-3.3</strong>: Caculate overall final quality flag</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-3-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-filtered-flux-after-level-3-3">Plot filtered flux after Level-3.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Reports</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-data-after-level-3-3">Overview: data after <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-variable-names">Flux variable names</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-quality-controlled-flux-after-level-3-3">Plot quality-controlled flux after <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-3-fluxes">Available <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code> fluxes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-level-3-3-results-to-file">Save Level-3.3 results to file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#export-for-mds-gap-filling-in-reddyproc">Export for MDS gap-filling in REddyProc</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-4-1-gap-filling">Level-4.1: <strong>GAP-FILLING</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-results">Get results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-scores">Model scores</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#names-of-gap-filled-variables">Names of gap-filled variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-gap-filled-heatmaps">Plot: gap-filled heatmaps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-gap-filled-cumulatives-per-year">Plot: Gap-filled cumulatives per year</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-gap-filled-cumulative-across-all-data">Plot: gap-filled cumulative across all data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model-feature-ranks-per-year">Plot: model feature ranks per year</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#save-results-to-file">Save results to file</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-save-complete-data-input-data-and-results">Option 1: Save complete data (input data and results)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-save-flux-processing-chain-results-without-input-data">Option 2: Save flux processing chain results (without input data)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-notebook"><strong>End of notebook</strong></a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="lop" src="images/logo_diive1_128px.png" /></p>
<span style='font-size:40px; display:block;'>
<b>
    Flux Processing Chain
</b>
</br>
</span>
<p>Post-processing of EddyPro <i>_fluxnet_</i> output files</p><hr class="docutils" />
<p><strong>Notebook version</strong>: <code class="docutils literal notranslate"><span class="pre">9.1</span></code> (4 Mar 2025)<br />
<strong>Author</strong>: Lukas Hörtnagl (<a class="reference external" href="mailto:holukas&#37;&#52;&#48;ethz&#46;ch">holukas<span>&#64;</span>ethz<span>&#46;</span>ch</a>)</p>
</br></br><hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="background">
<h1><strong>BACKGROUND</strong><a class="headerlink" href="#background" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>This notebook demonstrates part of the flux post-processing used for fluxes from Swiss FluxNet research stations</p></li>
<li><p>For a description of the different flux levels, see <a class="reference external" href="https://www.swissfluxnet.ethz.ch/index.php/data/ecosystem-fluxes/flux-processing-chain/">Flux Processing Chain</a></p></li>
<li><p>Flux calculations (Level-1) were done in a previous step</p></li>
<li><p>This notebook uses the calculated fluxes (Level-1) and applies several post-processing steps:</p>
<ul>
<li><p>Quality flag extension (Level-2)</p></li>
<li><p>Storage correction (Level-3.1)</p></li>
<li><p>Outlier removal (Level-3.2)</p></li>
<li><p>USTAR filtering (Level-3.3) - needs <em>known</em> thresholds from separate analysis, e.g. from FLUXNET</p></li>
<li><p>Gap-filling (Level-4.1) for flux using multiple methods (<a class="reference internal" href="#../GapFilling/FluxMDSGapFilling.ipynb"><span class="xref myst">MDS</span></a>, <a class="reference internal" href="#../GapFilling/LongTermRandomForestGapFilling.ipynb"><span class="xref myst">long-term random forest</span></a>)</p></li>
</ul>
</li>
<li><p>Other flux levels are currently not produced in this example:</p>
<ul>
<li><p>NEE Partitioning (Level-4.2)</p></li>
</ul>
</li>
</ul>
<p><strong>Important</strong></p>
<ul class="simple">
<li><p>Flux variable names in the input files should follow the <a class="reference external" href="https://fluxnet.org/data/fluxnet2015-dataset/fullset-data-product/">FLUXNET convention</a></p></li>
</ul>
</br></br></section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="general-settings">
<h1><strong>GENERAL SETTINGS</strong><a class="headerlink" href="#general-settings" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<section id="flux-variable">
<h2>Flux variable<a class="headerlink" href="#flux-variable" title="Link to this heading">#</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">FLUXVAR</span></code> is the name of the flux variable in the data files. In the EddyPro <code class="docutils literal notranslate"><span class="pre">_fluxnet_</span></code> output files, the flux variables we primarily use are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FC</span></code> … CO2 flux, becomes <code class="docutils literal notranslate"><span class="pre">NEE</span></code> after storage correction (Level-3.1)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LE</span></code> … Latent heat flux (water)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">H</span></code> … Sensible heat flux</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FN2O</span></code> … Nitrous oxide flux</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FCH4</span></code> … Methane flux</p></li>
</ul>
<p>There are more flux variables in the output file, but we rarely need them:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">FH2O</span></code> … H2O flux, very important but it is the same as <code class="docutils literal notranslate"><span class="pre">ET</span></code> and <code class="docutils literal notranslate"><span class="pre">LE</span></code> but with different units</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ET</span></code> … Evapotranspiration, very important but it is the same as <code class="docutils literal notranslate"><span class="pre">FH2O</span></code> and <code class="docutils literal notranslate"><span class="pre">LE</span></code> but with different units. We can easily calculte <code class="docutils literal notranslate"><span class="pre">ET</span></code> later from <code class="docutils literal notranslate"><span class="pre">LE</span></code>, e.g. in <code class="docutils literal notranslate"><span class="pre">ReddyProc</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TAU</span></code> … Momentum flux, a measure of the turbulent transfer of momentum between the land surface and the atmosphere</p></li>
</ul>
<p>Set the name of the flux variable in the output file(s), must use the FLUXNET naming convention, e.g. FC, FH2O, LE, ET, H, FN2O, FCH4:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FLUXVAR</span> <span class="o">=</span> <span class="s2">&quot;FC&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="site-location">
<h2>Site location<a class="headerlink" href="#site-location" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Latitude and longitude of the site where data were recorded. This info is mainly used to calculate potential radiation, which is then used to divide the dataset into daytime and nighttime data.</p></li>
<li><p>UTC offset of the timestamp used in the dataset, important for calculating potential radiation for this location with the correct timestamp.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SITE_LAT</span> <span class="o">=</span> <span class="mf">47.478333</span>   <span class="c1"># CH-LAE</span>
<span class="n">SITE_LON</span> <span class="o">=</span> <span class="mf">8.364389</span>  <span class="c1"># CH-LAE</span>
<span class="n">UTC_OFFSET</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Time stamp offset in relation to UTC, e.g. 1 for UTC+01:00 (CET), important for the calculation of potential radiation for detecting daytime and nighttime</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="daytime-nighttime">
<h2>Daytime/nighttime<a class="headerlink" href="#daytime-nighttime" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Threshold for potential radiation in <code class="docutils literal notranslate"><span class="pre">W</span> <span class="pre">m-2</span></code>, records below threshold are considered nighttime</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NIGHTTIME_THRESHOLD</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="quality-requirements">
<h2>Quality requirements<a class="headerlink" href="#quality-requirements" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The default setting is to accept highest-quality and medium-quality fluxes for daytime (overall quality flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> = 0 or 1), and highest-quality fluxes only for nighttime (flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> = 0)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DAYTIME_ACCEPT_QCF_BELOW</span> <span class="pre">=</span> <span class="pre">2</span></code> accepts high- (<code class="docutils literal notranslate"><span class="pre">QCF=0</span></code>) and medium-quality (<code class="docutils literal notranslate"><span class="pre">QCF=1</span></code>) fluxes for <em>daytime</em>, rejects low-quality (<code class="docutils literal notranslate"><span class="pre">QCF=2</span></code>) fluxes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NIGHTTIMETIME_ACCEPT_QCF_BELOW</span> <span class="pre">=</span> <span class="pre">1</span></code> accepts high-quality (<code class="docutils literal notranslate"><span class="pre">QCF=0</span></code>) fluxes for <em>nighttime</em>, rejects medium-quality (<code class="docutils literal notranslate"><span class="pre">QCF=1</span></code>) and low-quality (<code class="docutils literal notranslate"><span class="pre">QCF=2</span></code>) fluxes</p></li>
<li><p>This strict quality-filtering removes a lot of data points during nighttime</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">DAYTIME_ACCEPT_QCF_BELOW</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">NIGHTTIMETIME_ACCEPT_QCF_BELOW</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
</br></section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="imports">
<h1><strong>IMPORTS</strong><a class="headerlink" href="#imports" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>This notebook uses <code class="docutils literal notranslate"><span class="pre">diive</span></code> (<a class="reference external" href="https://github.com/holukas/diive">source code</a>) to check eddy covariance fluxes for quality</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">importlib.metadata</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.stats</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">diive.core.dfun.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">sstats</span>  <span class="c1"># Time series stats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">diive.core.io.files</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_parquet</span><span class="p">,</span> <span class="n">load_parquet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">diive.core.plotting.timeseries</span><span class="w"> </span><span class="kn">import</span> <span class="n">TimeSeries</span>  <span class="c1"># For simple (interactive) time series plotting</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">diive.pkgs.flux.hqflux</span><span class="w"> </span><span class="kn">import</span> <span class="n">analyze_highest_quality_flux</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">diive.pkgs.fluxprocessingchain.fluxprocessingchain</span><span class="w"> </span><span class="kn">import</span> <span class="n">FluxProcessingChain</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">diive.pkgs.fluxprocessingchain.fluxprocessingchain</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoadEddyProOutputFiles</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
<span class="n">version_diive</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">version</span><span class="p">(</span><span class="s2">&quot;diive&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;diive version: v</span><span class="si">{</span><span class="n">version_diive</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diive version: v0.87.1
</pre></div>
</div>
</div>
</div>
</br></br></section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="docstring-for-fluxprocessingchain">
<h1><strong>DOCSTRING</strong> for <code class="docutils literal notranslate"><span class="pre">FluxProcessingChain</span></code><a class="headerlink" href="#docstring-for-fluxprocessingchain" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># help(FluxProcessingChain)</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="load-data-2-options">
<h1><strong>LOAD DATA</strong> (2 options)<a class="headerlink" href="#load-data-2-options" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>It is possible to load data from (multiple) EddyPro <em>fluxnet</em> output files (data from files will be merged), or directly from one single <a class="reference external" href="https://parquet.apache.org/">parquet</a> file.</p></li>
<li><p>parquet files are a good option for large datasets because they load and save much faster than when using conventional CSV files.</p></li>
<li><p>For large datasets, it makes sense to first load and merge data from the original EddyPro <em>fluxnet</em> output files, then convert the merged data to one single parquet file and then use this file as input file.</p></li>
</ul>
</br><section id="option-1-load-data-from-single-or-multiple-eddypro-fluxnet-output-files">
<h2>Option 1: Load data from single or multiple EddyPro <em><em>fluxnet</em></em> output files<a class="headerlink" href="#option-1-load-data-from-single-or-multiple-eddypro-fluxnet-output-files" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Used to read data from the EddyPro <em>fluxnet</em> output files</p></li>
<li><p>Found files will be merged together into one single dataframe (<code class="docutils literal notranslate"><span class="pre">maindf</span></code>)</p></li>
</ul>
<p>If you want to search for EddyPro <em>fluxnet</em> files in specific locations, you can specify multiple folders here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Folder(s) where input file(s) are located</span>
<span class="c1"># SOURCEDIRS = [r&#39;example_data/&#39;]  </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ep = LoadEddyProOutputFiles(sourcedir=SOURCEDIRS, filetype=&#39;EDDYPRO-FLUXNET-CSV-30MIN&#39;)</span>
<span class="c1"># ep.searchfiles()</span>
<span class="c1"># ep.loadfiles()</span>
<span class="c1"># maindf = ep.maindf</span>
<span class="c1"># metadata = ep.metadata</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="option-2-load-data-from-parquet-file">
<h2>Option 2: Load data from <code class="docutils literal notranslate"><span class="pre">parquet</span></code> file<a class="headerlink" href="#option-2-load-data-from-parquet-file" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Can be used to continue a previous session where another flux variable was already post-processed</p></li>
<li><p>For example, if you have already post-processed CO2 flux and now want to post-process H2O flux</p></li>
<li><p>Also detects time resolution of time series, this info was lost when saving to the parquet file</p></li>
</ul>
<p>If you want to load data directly from a specific parquet file, you can specify its name and location here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SOURCEDIR</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;</span>
<span class="n">FILENAME</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;03.2_FC_OPENLAG_EDDYPRO_FLUXNET_OUTPUT_IRGA72_2016-2024.parquet&quot;</span>
<span class="n">FILEPATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">SOURCEDIR</span><span class="p">)</span> <span class="o">/</span> <span class="n">FILENAME</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data will be loaded from the following file:</span><span class="se">\n</span><span class="si">{</span><span class="n">FILEPATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data will be loaded from the following file:
03.2_FC_OPENLAG_EDDYPRO_FLUXNET_OUTPUT_IRGA72_2016-2024.parquet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">maindf</span> <span class="o">=</span> <span class="n">load_parquet</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">FILEPATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loaded .parquet file 03.2_FC_OPENLAG_EDDYPRO_FLUXNET_OUTPUT_IRGA72_2016-2024.parquet (0.440 seconds).
    --&gt; Detected time resolution of &lt;30 * Minutes&gt; / 30min 
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="option-3-load-example-data">
<h2>Option 3: Load example data<a class="headerlink" href="#option-3-load-example-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.configs.exampledata import load_exampledata_EDDYPRO_FLUXNET_CSV_30MIN</span>
<span class="c1"># maindf, metadata = load_exampledata_EDDYPRO_FLUXNET_CSV_30MIN()</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="optional-restrict-data-to-time-range">
<h2>(Optional) Restrict data to time range<a class="headerlink" href="#optional-restrict-data-to-time-range" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Restrict data range</span>
<span class="n">maindf</span> <span class="o">=</span> <span class="n">maindf</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">maindf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&gt;=</span> <span class="mi">2017</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">maindf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">&lt;=</span> <span class="mi">2024</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="check-data">
<h2>Check data<a class="headerlink" href="#check-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span><span class="p">(</span><span class="n">maindf</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">maindf</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">display</span><span class="p">(</span><span class="n">sstats</span><span class="p">(</span><span class="n">maindf</span><span class="p">[</span><span class="n">FLUXVAR</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AIR_CP</th>
      <th>AIR_DENSITY</th>
      <th>AIR_MV</th>
      <th>AIR_RHO_CP</th>
      <th>AOA_METHOD</th>
      <th>AXES_ROTATION_METHOD</th>
      <th>...</th>
      <th>SW_IN_T1_47_1_gfXG</th>
      <th>TA_T1_47_1_gfXG</th>
      <th>PPFD_IN_T1_47_1_gfXG</th>
      <th>VPD_T1_47_1</th>
      <th>VPD_T1_47_1_gfXG</th>
      <th>FLAG_VPD_T1_47_1_gfXG_ISFILLED</th>
    </tr>
    <tr>
      <th>TIMESTAMP_MIDDLE</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01 00:15:00</th>
      <td>1007.20</td>
      <td>1.16100</td>
      <td>0.024942</td>
      <td>1169.36</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>-5.089633</td>
      <td>0.0</td>
      <td>0.000566</td>
      <td>0.000566</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-01-01 00:45:00</th>
      <td>1007.18</td>
      <td>1.16086</td>
      <td>0.024945</td>
      <td>1169.19</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>-5.140866</td>
      <td>0.0</td>
      <td>0.000563</td>
      <td>0.000563</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2017-01-01 01:15:00</th>
      <td>1007.12</td>
      <td>1.16529</td>
      <td>0.024851</td>
      <td>1173.58</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>-5.393694</td>
      <td>0.0</td>
      <td>0.000553</td>
      <td>0.000553</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 507 columns</p>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AIR_CP</th>
      <th>AIR_DENSITY</th>
      <th>AIR_MV</th>
      <th>AIR_RHO_CP</th>
      <th>AOA_METHOD</th>
      <th>AXES_ROTATION_METHOD</th>
      <th>...</th>
      <th>SW_IN_T1_47_1_gfXG</th>
      <th>TA_T1_47_1_gfXG</th>
      <th>PPFD_IN_T1_47_1_gfXG</th>
      <th>VPD_T1_47_1</th>
      <th>VPD_T1_47_1_gfXG</th>
      <th>FLAG_VPD_T1_47_1_gfXG_ISFILLED</th>
    </tr>
    <tr>
      <th>TIMESTAMP_MIDDLE</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2024-12-31 22:45:00</th>
      <td>1007.82</td>
      <td>1.14946</td>
      <td>0.025191</td>
      <td>1158.44</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>-0.392922</td>
      <td>0.0</td>
      <td>0.060608</td>
      <td>0.060608</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2024-12-31 23:15:00</th>
      <td>1007.71</td>
      <td>1.14668</td>
      <td>0.025253</td>
      <td>1155.52</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.792661</td>
      <td>0.0</td>
      <td>0.117695</td>
      <td>0.117695</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2024-12-31 23:45:00</th>
      <td>1007.78</td>
      <td>1.15011</td>
      <td>0.025177</td>
      <td>1159.05</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>-0.422600</td>
      <td>0.0</td>
      <td>0.069221</td>
      <td>0.069221</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 507 columns</p>
</div></div><div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>STARTDATE</th>
      <td>2017-01-01 00:15</td>
    </tr>
    <tr>
      <th>ENDDATE</th>
      <td>2024-12-31 23:45</td>
    </tr>
    <tr>
      <th>PERIOD</th>
      <td>2921 days 23:30:00</td>
    </tr>
    <tr>
      <th>NOV</th>
      <td>128967</td>
    </tr>
    <tr>
      <th>MISSING</th>
      <td>11289</td>
    </tr>
    <tr>
      <th>MISSING_PERC</th>
      <td>8.048854</td>
    </tr>
    <tr>
      <th>MEAN</th>
      <td>-0.843326</td>
    </tr>
    <tr>
      <th>MEDIAN</th>
      <td>0.216977</td>
    </tr>
    <tr>
      <th>SD</th>
      <td>16.677658</td>
    </tr>
    <tr>
      <th>VAR</th>
      <td>278.144261</td>
    </tr>
    <tr>
      <th>SD/MEAN</th>
      <td>-19.776044</td>
    </tr>
    <tr>
      <th>SUM</th>
      <td>-108761.262433</td>
    </tr>
    <tr>
      <th>MIN</th>
      <td>-1223.5</td>
    </tr>
    <tr>
      <th>MAX</th>
      <td>1112.36</td>
    </tr>
    <tr>
      <th>P01</th>
      <td>-32.515296</td>
    </tr>
    <tr>
      <th>P05</th>
      <td>-19.42459</td>
    </tr>
    <tr>
      <th>P25</th>
      <td>-4.023365</td>
    </tr>
    <tr>
      <th>P75</th>
      <td>2.81519</td>
    </tr>
    <tr>
      <th>P95</th>
      <td>12.36515</td>
    </tr>
    <tr>
      <th>P99</th>
      <td>37.772186</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># maindf[&#39;VPD_T1_47_1&#39;].describe()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TimeSeries(series=maindf[FLUXVAR]).plot_interactive()</span>
<span class="n">TimeSeries</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">maindf</span><span class="p">[</span><span class="n">FLUXVAR</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/79f4e8007dcf6caf6ee8e67c9d3fe1097696093c94d8ee5529f849ef9f4e5ef9.png" src="../../_images/79f4e8007dcf6caf6ee8e67c9d3fe1097696093c94d8ee5529f849ef9f4e5ef9.png" />
</div>
</div>
</br></br></section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="start-flux-processing-chain">
<h1><strong>START FLUX PROCESSING CHAIN</strong><a class="headerlink" href="#start-flux-processing-chain" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>First we need to initialize the processing chain by providing some basic info.</p></li>
<li><p>At the same time, some fundamental variables are also created: potential radiation, and two flags based on it: daytime flag (1=daytime) and nighttime flag (1=nighttime).</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span> <span class="o">=</span> <span class="n">FluxProcessingChain</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">maindf</span><span class="p">,</span>
    <span class="n">fluxcol</span><span class="o">=</span><span class="n">FLUXVAR</span><span class="p">,</span>
    <span class="n">site_lat</span><span class="o">=</span><span class="n">SITE_LAT</span><span class="p">,</span>
    <span class="n">site_lon</span><span class="o">=</span><span class="n">SITE_LON</span><span class="p">,</span>
    <span class="n">utc_offset</span><span class="o">=</span><span class="n">UTC_OFFSET</span><span class="p">,</span>    
    <span class="n">nighttime_threshold</span><span class="o">=</span><span class="n">NIGHTTIME_THRESHOLD</span><span class="p">,</span>
    <span class="n">daytime_accept_qcf_below</span><span class="o">=</span><span class="n">DAYTIME_ACCEPT_QCF_BELOW</span><span class="p">,</span>
    <span class="n">nighttimetime_accept_qcf_below</span><span class="o">=</span><span class="n">NIGHTTIMETIME_ACCEPT_QCF_BELOW</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detected base variable CO2 for FC. (CO2 was used to calculate FC.)
Calculated potential radiation from latitude and longitude (SW_IN_POT) ... 
Calculated daytime flag DAYTIME and nighttime flag NIGHTTIME from SW_IN_POT ...
++ Added new column SW_IN_POT to input data.  (!) Existing SW_IN_POT in input data is overwritten.
++ Added new column DAYTIME to input data.
++ Added new column NIGHTTIME to input data.
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Let’s check the flux processing chain dataframe: this are the data the chain is working with in this run:</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FC</th>
      <th>USTAR</th>
      <th>SW_IN_POT</th>
      <th>DAYTIME</th>
      <th>NIGHTTIME</th>
    </tr>
    <tr>
      <th>TIMESTAMP_MIDDLE</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01 00:15:00</th>
      <td>2.321600</td>
      <td>0.119926</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 00:45:00</th>
      <td>2.153140</td>
      <td>0.088974</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 01:15:00</th>
      <td>4.381530</td>
      <td>0.219446</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 01:45:00</th>
      <td>0.582897</td>
      <td>0.158594</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 02:15:00</th>
      <td>0.607510</td>
      <td>0.169269</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-12-31 21:45:00</th>
      <td>-3.929310</td>
      <td>0.245204</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 22:15:00</th>
      <td>-8.797730</td>
      <td>0.388422</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 22:45:00</th>
      <td>-6.486530</td>
      <td>0.532218</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 23:15:00</th>
      <td>-19.688700</td>
      <td>0.590691</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 23:45:00</th>
      <td>6.390400</td>
      <td>0.460941</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>140256 rows × 5 columns</p>
</div></div></div>
</div>
</br></br></section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="level-2-quality-flag-extension">
<h1>Level-2: <strong>QUALITY FLAG EXTENSION</strong><a class="headerlink" href="#level-2-quality-flag-extension" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<blockquote>
<div><p>Extract additional quality information from the EddyPro output and store it in newly added quality flags.</p>
</div></blockquote>
<p>Note that the USTAR filtering is not part of the Level-2 calculations.</p>
</br><section id="user-settings">
<h2>User settings<a class="headerlink" href="#user-settings" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>A test for missing values is always included: flag calculated here from missing flux values in the EddyPro output file</p></li>
</ul>
</br><section id="ssitc-tests-default-true">
<h3>SSITC tests (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)<a class="headerlink" href="#ssitc-tests-default-true" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Flag calculated in EddyPro</p></li>
<li><p>Combination of the two partial tests <em>steady state test</em> and <em>developed turbulent conditions test</em></p></li>
<li><p>This notebook expects the SSITC flag to follow the flagging policy according to Mauder and Foken 2004:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> for best quality fluxes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> for fluxes suitable for general analysis such as annual budgets (although this is debatable for nighttime data)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> for fluxes that should be discarded from the dataset</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_SSITC</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default True</span>
<span class="n">TEST_SSITC_SETFLAG_TIMEPERIOD</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;2022-05-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2023-09-30&#39;</span><span class="p">]]}</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="flux-base-variable-completeness-test-default-true">
<h3>Flux base variable completeness test (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)<a class="headerlink" href="#flux-base-variable-completeness-test-default-true" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Flag newly calculated here</p></li>
<li><p>Check completeness of the variable that was used to calculate the respective flux</p></li>
<li><p>Example: <code class="docutils literal notranslate"><span class="pre">CO2</span></code> is the base variable that was used to calculate flux <code class="docutils literal notranslate"><span class="pre">FC</span></code>, the test is therefore run on <code class="docutils literal notranslate"><span class="pre">CO2</span></code></p></li>
<li><p>Checks number of records of the relevant base variable available for each averaging Interval and calculates completeness flag as follows:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">0</span></code> for files where &gt;= 99% of base variable are available</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">1</span></code> for files where &gt;= 97% and &lt; 99% of base variable are available</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">2</span></code> for files where &lt; 97% of base variable are available</p></li>
</ul>
</li>
</ul>
<p>List of flux base variables and the corresponding fluxes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CO2</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">FC</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">H2O</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">FH2O</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">H2O</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">LE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">H2O</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">ET</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">T_SONIC</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">H</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">N2O</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">FN2O</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CH4</span></code>: used to calculate <code class="docutils literal notranslate"><span class="pre">FCH4</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_GAS_COMPLETENESS</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default True</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="spectral-correction-factor-test-default-true">
<h3>Spectral correction factor test (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)<a class="headerlink" href="#spectral-correction-factor-test-default-true" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Flag calculated here from the gas <code class="docutils literal notranslate"><span class="pre">SCF</span></code> variable in EddyPro output file</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_SPECTRAL_CORRECTION_FACTOR</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default True</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="signal-strength-test">
<h3>Signal strength test<a class="headerlink" href="#signal-strength-test" title="Link to this heading">#</a></h3>
<div class="alert alert-block alert-info">
<b>Always recommended if flux was calculated using a gas analyzer.</b>
</div>  <div class="alert alert-block alert-danger">
<b>Do not use for H (sensible heat flux).</b> This test is only relevant for fluxes where the concentration/temperature was measured by a gas analyzer, e.g. FC, FH2O, LE, ET, N2O, CH4, etc ... 
</div>  <ul class="simple">
<li><p>Signal strength / AGC / window dirtiness test (if available)</p></li>
<li><p>Flag calculated here from the signal strength / AGC variable for the gas analyzer in EddyPro output file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SIGNAL_STRENGTH_COL</span></code>: Name of the column storing the signal strength, typically ‘CUSTOM_AGC_MEAN’ for LI-7500, ‘CUSTOM_SIGNAL_STRENGTH_IRGA72_MEAN’ for LI-7200, or something similar</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SIGNAL_STRENGTH_THRESHOLD</span></code>: Signal strength threshold, flux values where threshold is exceeded are flagged as rejected</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SIGNAL_STRENGTH_METHOD</span></code>: <code class="docutils literal notranslate"><span class="pre">discard</span> <span class="pre">above</span></code> flags fluxes where signal strength &gt; threshold, <code class="docutils literal notranslate"><span class="pre">discard</span> <span class="pre">below</span></code> where signal strength &lt; threshold</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Signal strength</span>
<span class="n">TEST_SIGNAL_STRENGTH</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">TEST_SIGNAL_STRENGTH_COL</span> <span class="o">=</span> <span class="s1">&#39;CUSTOM_SIGNAL_STRENGTH_IRGA72_MEAN&#39;</span>  <span class="c1"># Typical variable name in fluxnet files</span>
<span class="n">TEST_SIGNAL_STRENGTH_METHOD</span> <span class="o">=</span> <span class="s1">&#39;discard below&#39;</span>
<span class="n">TEST_SIGNAL_STRENGTH_THRESHOLD</span> <span class="o">=</span> <span class="mi">50</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TimeSeries(series=df_orig[SIGNAL_STRENGTH_COL]).plot_interactive()</span>
<span class="n">TimeSeries</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">maindf</span><span class="p">[</span><span class="n">TEST_SIGNAL_STRENGTH_COL</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/09e7ec49463947e2e26a7a7f7faebd939b8519519e4356cd89fafc00c32cf238.png" src="../../_images/09e7ec49463947e2e26a7a7f7faebd939b8519519e4356cd89fafc00c32cf238.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># [print(c) for c in maindf.columns if &quot;SIGNAL&quot; in c]</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="raw-data-screening-tests">
<h3>Raw data screening tests<a class="headerlink" href="#raw-data-screening-tests" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Flags were calculated in EddyPro</p></li>
<li><p>See here for more details: <a class="reference external" href="https://www.licor.com/env/support/EddyPro/topics/despiking-raw-statistical-screening.html">Despiking and raw data statistical screening (EddyPro help)</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_RAWDATA</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default True</span>
<span class="n">TEST_RAWDATA_SPIKES</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default True</span>
<span class="n">TEST_RAWDATA_AMPLITUDE</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default True</span>
<span class="n">TEST_RAWDATA_DROPOUT</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Default True</span>
<span class="n">TEST_RAWDATA_ABSLIM</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
<span class="n">TEST_RAWDATA_SKEWKURT_HF</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
<span class="n">TEST_RAWDATA_SKEWKURT_SF</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
<span class="n">TEST_RAWDATA_DISCONT_HF</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
<span class="n">TEST_RAWDATA_DISCONT_SF</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="angle-of-attack-test-default-false">
<h3>Angle-of-attack test (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>)<a class="headerlink" href="#angle-of-attack-test-default-false" title="Link to this heading">#</a></h3>
<blockquote>
<div><p>This test calculates sample-wise Angle of Attacks throughout the current flux averaging period, and flags it if the percentage of angles of attack exceeding a user-defined range is beyond a (user-defined) threshold.<br />
Source: <a class="reference external" href="https://www.licor.com/env/support/EddyPro/topics/despiking-raw-statistical-screening.html?Highlight=angle%20of%20attack#Angleofattack">EddyPro help</a>  <em>(3 Jan 2024)</em></p>
</div></blockquote>
<ul class="simple">
<li><p>Flag was calculated in EddyPro</p></li>
<li><p>Flag can be useful during some time periods when the sonic anemometer had issues</p></li>
<li><p>Not used by default (similar to ICOS)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_RAWDATA_ANGLE_OF_ATTACK</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
<span class="c1"># TEST_RAWDATA_ANGLE_OF_ATTACK_APPLICATION_DATES = []</span>
<span class="n">TEST_RAWDATA_ANGLE_OF_ATTACK_APPLICATION_DATES</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;2008-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2010-01-01&#39;</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="s1">&#39;2016-03-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2016-05-01&#39;</span><span class="p">],</span>
                                                  <span class="p">[</span><span class="s1">&#39;2021-12-10&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-12-23&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="steadiness-of-horizontal-wind-test-default-false">
<h3>Steadiness of horizontal wind test (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>)<a class="headerlink" href="#steadiness-of-horizontal-wind-test-default-false" title="Link to this heading">#</a></h3>
<blockquote>
<div><p>This test assesses whether the along-wind and crosswind components of the wind vector undergo a systematic reduction (or increase) throughout the file. If the quadratic combination of such systematic variations is beyond the user-selected limit, the flux averaging period is hard-flagged for instationary horizontal wind (Vickers and Mahrt, 1997, Par. 6g).<br />
Source: <a class="reference external" href="https://www.licor.com/env/support/EddyPro/topics/despiking-raw-statistical-screening.html?Highlight=angle%20of%20attack#Steadinessofhorizontalwind">EddyPro help</a>  <em>(3 Jan 2024)</em></p>
</div></blockquote>
<ul class="simple">
<li><p>Flag was calculated in EddyPro</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_RAWDATA_STEADINESS_OF_HORIZONTAL_WIND</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default False</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
</section>
<section id="run">
<h2>Run<a class="headerlink" href="#run" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">LEVEL2_SETTINGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;signal_strength&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_SIGNAL_STRENGTH</span><span class="p">,</span>
        <span class="s1">&#39;signal_strength_col&#39;</span><span class="p">:</span> <span class="n">TEST_SIGNAL_STRENGTH_COL</span><span class="p">,</span>
        <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">TEST_SIGNAL_STRENGTH_METHOD</span><span class="p">,</span>
        <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">TEST_SIGNAL_STRENGTH_THRESHOLD</span><span class="p">},</span>
    <span class="s1">&#39;raw_data_screening_vm97&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA</span><span class="p">,</span>
        <span class="s1">&#39;spikes&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_SPIKES</span><span class="p">,</span>
        <span class="s1">&#39;amplitude&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_AMPLITUDE</span><span class="p">,</span>
        <span class="s1">&#39;dropout&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_DROPOUT</span><span class="p">,</span>
        <span class="s1">&#39;abslim&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_ABSLIM</span><span class="p">,</span>
        <span class="s1">&#39;skewkurt_hf&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_SKEWKURT_HF</span><span class="p">,</span>
        <span class="s1">&#39;skewkurt_sf&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_SKEWKURT_SF</span><span class="p">,</span>
        <span class="s1">&#39;discont_hf&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_DISCONT_HF</span><span class="p">,</span>
        <span class="s1">&#39;discont_sf&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_DISCONT_SF</span><span class="p">},</span>
    <span class="s1">&#39;ssitc&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_SSITC</span><span class="p">,</span>
        <span class="s1">&#39;setflag_timeperiod&#39;</span><span class="p">:</span> <span class="n">TEST_SSITC_SETFLAG_TIMEPERIOD</span><span class="p">},</span>
    <span class="s1">&#39;gas_completeness&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_GAS_COMPLETENESS</span><span class="p">},</span>
    <span class="s1">&#39;spectral_correction_factor&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_SPECTRAL_CORRECTION_FACTOR</span><span class="p">},</span>
    <span class="s1">&#39;angle_of_attack&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_ANGLE_OF_ATTACK</span><span class="p">,</span>
        <span class="s1">&#39;application_dates&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_ANGLE_OF_ATTACK_APPLICATION_DATES</span><span class="p">},</span>
    <span class="s1">&#39;steadiness_of_horizontal_wind&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;apply&#39;</span><span class="p">:</span> <span class="n">TEST_RAWDATA_STEADINESS_OF_HORIZONTAL_WIND</span><span class="p">}</span>
<span class="p">}</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">level2_quality_flag_expansion</span><span class="p">(</span><span class="o">**</span><span class="n">LEVEL2_SETTINGS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[MissingValues]  running MissingValues ...
SSITC TEST: Generated new flag variable FLAG_L2_FC_SSITC_TEST, values taken from output variable FC_SSITC_TEST ...
    Flag FLAG_L2_FC_SSITC_TEST with value 1 was set to 2 between 2022-05-01 and 2023-09-30
SPECTRAL CORRECTION FACTOR TEST: Generating new flag variable FLAG_L2_FC_SCF_TEST, newly calculated from output variable FC_SCF, withflag 0 (good values) where FC_SCF &lt; 2, flag 1 (ok values) where FC_SCF &gt;= 2 and &lt; 4, flag 2 (bad values) where FC_SCF &gt;= 4...
SIGNAL STRENGTH TEST: Generating new flag variable FLAG_L2_FC_SIGNAL_STRENGTH_TEST, newly calculated from output variable CUSTOM_SIGNAL_STRENGTH_IRGA72_MEAN, with flag 0 (good values) where CUSTOM_SIGNAL_STRENGTH_IRGA72_MEAN &gt;= 50, flag 2 (bad values) where CUSTOM_SIGNAL_STRENGTH_IRGA72_MEAN &lt; 50 ...
RAW DATA TEST: Generated new flag variable FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST, values taken from output variable CO2_VM97_TEST from position 1, based on CO2, with flag 0 (good values) where test passed, flag 2 (bad values) where test failed (for hard flags) or flag 1 (ok values) where test failed (for soft flags) ...
RAW DATA TEST: Generated new flag variable FLAG_L2_FC_CO2_VM97_DROPOUT_TEST, values taken from output variable CO2_VM97_TEST from position 3, based on CO2, with flag 0 (good values) where test passed, flag 2 (bad values) where test failed (for hard flags) or flag 1 (ok values) where test failed (for soft flags) ...
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="finalize-level-2">
<h2>Finalize Level-2<a class="headerlink" href="#finalize-level-2" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">finalize_level2</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>++Added new column FLAG_L2_FC_MISSING_TEST.
++Added new column FLAG_L2_FC_SSITC_TEST.
++Added new column FLAG_L2_FC_SCF_TEST.
++Added new column FLAG_L2_FC_SIGNAL_STRENGTH_TEST.
++Added new column FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST.
++Added new column FLAG_L2_FC_CO2_VM97_DROPOUT_TEST.
++Added new column SUM_L2_FC_HARDFLAGS.
++Added new column SUM_L2_FC_SOFTFLAGS.
++Added new column SUM_L2_FC_FLAGS.
++Added new column FLAG_L2_FC_QCF.
++Added new column FC_L2_QCF.
++Added new column FC_L2_QCF0.
</pre></div>
</div>
</div>
</div>
</br><section id="available-level-2-variables">
<h3>Available <code class="docutils literal notranslate"><span class="pre">Level-2</span></code> variables<a class="headerlink" href="#available-level-2-variables" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This shows all available Level-2 variables for this flux</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;L2&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;FLAG_L2_FC_MISSING_TEST&#39;,
 &#39;FLAG_L2_FC_SSITC_TEST&#39;,
 &#39;FLAG_L2_FC_SCF_TEST&#39;,
 &#39;FLAG_L2_FC_SIGNAL_STRENGTH_TEST&#39;,
 &#39;FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST&#39;,
 &#39;FLAG_L2_FC_CO2_VM97_DROPOUT_TEST&#39;,
 &#39;SUM_L2_FC_HARDFLAGS&#39;,
 &#39;SUM_L2_FC_SOFTFLAGS&#39;,
 &#39;SUM_L2_FC_FLAGS&#39;,
 &#39;FLAG_L2_FC_QCF&#39;,
 &#39;FC_L2_QCF&#39;,
 &#39;FC_L2_QCF0&#39;]
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="plots">
<h3>Plots<a class="headerlink" href="#plots" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level2_qcf</span><span class="o">.</span><span class="n">showplot_qcf_heatmaps</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3afd1053e5cfab41fdfe5966ee88f5273d265f17792c3b8ff6fe1c2ab7e60646.png" src="../../_images/3afd1053e5cfab41fdfe5966ee88f5273d265f17792c3b8ff6fe1c2ab7e60646.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level2_qcf.showplot_qcf_timeseries()</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="reports">
<h3>Reports<a class="headerlink" href="#reports" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level2_qcf</span><span class="o">.</span><span class="n">report_qcf_evolution</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
QCF FLAG EVOLUTION
========================================
This output shows the evolution of the QCF overall quality flag
when test flags are applied sequentially to the variable FC.

Number of FC records before QC: 128967
+++ FLAG_L2_FC_MISSING_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 128967 (100.00%) / flag 1: 0 (0.00%) / flag 2: 0 (0.00%)
+++ FLAG_L2_FC_SSITC_TEST rejected 58965 values (+45.72%)      TOTALS: flag 0: 46234 (35.85%) / flag 1: 23768 (18.43%) / flag 2: 58965 (45.72%)
+++ FLAG_L2_FC_SCF_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 46234 (35.85%) / flag 1: 23768 (18.43%) / flag 2: 58965 (45.72%)
+++ FLAG_L2_FC_SIGNAL_STRENGTH_TEST rejected 146 values (+0.11%)      TOTALS: flag 0: 46167 (35.80%) / flag 1: 23689 (18.37%) / flag 2: 59111 (45.83%)
+++ FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST rejected 8 values (+0.01%)      TOTALS: flag 0: 46162 (35.79%) / flag 1: 23686 (18.37%) / flag 2: 59119 (45.84%)
+++ FLAG_L2_FC_CO2_VM97_DROPOUT_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 46162 (35.79%) / flag 1: 23686 (18.37%) / flag 2: 59119 (45.84%)

In total, 59119 (45.84%) of the available records were rejected in this step.
INFO Rejected DAYTIME records where QCF flag &gt;= 2
INFO Rejected NIGHTTIME records where QCF flag &gt;= 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level2_qcf</span><span class="o">.</span><span class="n">report_qcf_series</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
SUMMARY: FLAG_L2_FC_QCF, QCF FLAG FOR FC
========================================
Between 2017-01-01 00:15 and 2024-12-31 23:45 ...
    Total flux records BEFORE quality checks: 128967 (91.95% of potential)
    Available flux records AFTER quality checks: 69848 (54.16% of total)
    Rejected flux records: 59119 (45.84% of total)
    Potential flux records: 140256
    Potential flux records missed: 11289 (8.05% of potential)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level2_qcf.report_qcf_flags()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
</section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="level-3-1-storage-correction">
<h1>Level-3.1: <strong>STORAGE CORRECTION</strong><a class="headerlink" href="#level-3-1-storage-correction" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>The flux storage term (single point) is added to the flux</p></li>
<li><p>For some records, the storage term can be missing. In such cases, missing terms are gap-filled using the rolling mean in an expanding window.</p></li>
<li><p>Without gap-filling the storage term, we can lose an additional e.g. 2-3% of flux data</p></li>
</ul>
</br><section id="id1">
<h2>Run<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level31_storage_correction</span><span class="p">(</span><span class="n">gapfill_storage_term</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Detected storage variable SC_SINGLE for FC.
Calculating storage-corrected flux NEE_L3.1 from flux FC and storage term SC_SINGLE ...
Missing values for storage term SC_SINGLE_gfRMED_L3.1: 501
Gap-filling storage-term SC_SINGLE with rolling median (window size = 5 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 391 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 7 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 124 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 9 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 98 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 11 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 71 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 13 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 53 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 15 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 38 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 17 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 29 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 19 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 24 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 21 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 20 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 23 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 17 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 25 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 15 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 27 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 14 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 29 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 12 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 31 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 11 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 33 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 9 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 35 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 8 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 37 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 3 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 39 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 2 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 45 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 1 ...
Gap-filling storage-term SC_SINGLE with rolling median (window size = 81 records, centered)  |  still missing values for storage term SC_SINGLE_gfRMED_L3.1: 0 ...
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="finalize-level-3-1">
<h2><strong>Finalize Level-3.1</strong><a class="headerlink" href="#finalize-level-3-1" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">finalize_level31</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>++Added new column SC_SINGLE.
++Added new column SC_SINGLE_gfRMED_L3.1.
++Added new column FLAG_SC_SINGLE_gfRMED_L3.1_ISFILLED.
++Added new column NEE_L3.1.
++Added new column NEE_L3.1_QCF (Level-3.1 with applied quality flag from Level-2).
++Added new column NEE_L3.1_QCF0 (Level-3.1 with applied quality flag from Level-2).
</pre></div>
</div>
</div>
</div>
</br><section id="available-level-3-1-variables">
<h3>Available <code class="docutils literal notranslate"><span class="pre">Level-3.1</span></code> variables<a class="headerlink" href="#available-level-3-1-variables" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This shows all available Level-3.1 variables for this flux</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;L3.1&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;SC_SINGLE_gfRMED_L3.1&#39;,
 &#39;FLAG_SC_SINGLE_gfRMED_L3.1_ISFILLED&#39;,
 &#39;NEE_L3.1&#39;,
 &#39;NEE_L3.1_QCF&#39;,
 &#39;NEE_L3.1_QCF0&#39;]
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="id2">
<h3>Plots<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level31</span><span class="o">.</span><span class="n">showplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/bae61b4a01e738ceb6a49a5214dadeee6224e6ead8bddf4767f5239b855fc012.png" src="../../_images/bae61b4a01e738ceb6a49a5214dadeee6224e6ead8bddf4767f5239b855fc012.png" />
</div>
</div>
</br></section>
<section id="report">
<h3>Report<a class="headerlink" href="#report" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level31</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
REPORT: STORAGE CORRECTION FOR FC
========================================
Swiss FluxNet processing chain, _L3.1: Storage Correction

The gap-filled storage term SC_SINGLE_gfRMED_L3.1 was added to flux FC.
The storage-corrected flux was stored as NEE_L3.1.

The flux was available for 128967 records (FC).
The original, non-gapfilled storage term was available for 128466 records (SC_SINGLE).
The original storage term SC_SINGLE was missing for 501 flux records.
Without gap-filling the storage term (SC_SINGLE), 501 measured flux records (FC) are lost.

For this run, gap-filling of SC_SINGLE was * SELECTED *.
After gap-filling the storage term, it was available for an additional 501 records (SC_SINGLE_gfRMED_L3.1).

In the storage-corrected flux NEE_L3.1 with 128967 records, 
  - 99.6% (128466 records) of used storage terms come from originally calculated data (SC_SINGLE)
  - 0.4% (501 records) of used storage terms come from gap-filled data (SC_SINGLE_gfRMED_L3.1)

Stats for gap-filled storage terms:
                       NOV      P01    MEDIAN      P99
SC_SINGLE_gfRMED_L3.1  501 -82.6831 -0.153759  25.7213

Stats for measured storage terms:
                          NOV       P01    MEDIAN        P99
SC_SINGLE_gfRMED_L3.1  128466 -10.29948  0.025695  10.054675
</pre></div>
</div>
</div>
</div>
</br></section>
</section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="optional-analyze-highest-quality-flux-so-far">
<h1>Optional: <strong>Analyze highest-quality flux</strong> (so far)<a class="headerlink" href="#optional-analyze-highest-quality-flux-so-far" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>Analysis of fluxes after Level-3.1 where the overall quality flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> = 0</p></li>
<li><p>This helps in understanding in what range the “true” flux occurs</p></li>
<li><p>Here, the highest-quality fluxes are additionally filtered for outlier values using the relatively fast Local Outlier Factor test</p></li>
<li><p>For this quick analysis, it is possible that the outlier test cuts off some “real” values that should be retained, but it nevertheless helps in understanding the flux range</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">QCF</span></code> = 0 is best quality, <code class="docutils literal notranslate"><span class="pre">QCF</span></code> = medium quality, <code class="docutils literal notranslate"><span class="pre">QCF</span></code> = 2 bad quality and always rejected</p></li>
<li><p>The difference between quality 0 and quality 1 or 2 is huge</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">analyze_highest_quality_flux</span><span class="p">(</span><span class="n">flux</span><span class="o">=</span><span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries_hq</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">nighttime_flag</span><span class="o">=</span><span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="s1">&#39;NIGHTTIME&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; Removing outliers from highest-quality DAYTIME fluxes (NEE_L3.1_QCF0)
&gt;&gt;&gt; Outlier removal method: Local outlier factor across all data (n_neighbors=138, contamination=auto, repeat=False)
[LocalOutlierFactorAllData]  running LocalOutlierFactorAllData ...
ITERATION#1: Total found outliers: 117 values (daytime+nighttime)
&gt;&gt;&gt; Largest non-outlier flux &gt;= 0 DAYTIME:   81.29966999999999
&gt;&gt;&gt; Smallest non-outlier flux &gt;= 0 DAYTIME:  0.0009160000000000279
&gt;&gt;&gt; Largest non-outlier flux &lt; 0 DAYTIME:    -0.0010609999999999786
&gt;&gt;&gt; Smallest non-outlier flux &lt; 0 DAYTIME:   -44.11433
&gt;&gt;&gt; Largest outlier flux &gt;= 0 DAYTIME:   471.88469999999995
&gt;&gt;&gt; Smallest outlier flux &gt;= 0 DAYTIME:  81.997901
&gt;&gt;&gt; Largest outlier flux &lt; 0 DAYTIME:    -44.382470000000005
&gt;&gt;&gt; Smallest outlier flux &lt; 0 DAYTIME:   -139.46478000000002

&gt;&gt;&gt; Removing outliers from highest-quality NIGHTTIME fluxes (NEE_L3.1_QCF0)
&gt;&gt;&gt; Outlier removal method: Local outlier factor across all data (n_neighbors=92, contamination=auto, repeat=False)
[LocalOutlierFactorAllData]  running LocalOutlierFactorAllData ...
ITERATION#1: Total found outliers: 109 values (daytime+nighttime)
&gt;&gt;&gt; Largest non-outlier flux &gt;= 0 NIGHTTIME:   34.830746999999995
&gt;&gt;&gt; Smallest non-outlier flux &gt;= 0 NIGHTTIME:  0.000400000000000178
&gt;&gt;&gt; Largest non-outlier flux &lt; 0 NIGHTTIME:    -1.8999999999991246e-05
&gt;&gt;&gt; Smallest non-outlier flux &lt; 0 NIGHTTIME:   -14.47978
&gt;&gt;&gt; Largest outlier flux &gt;= 0 NIGHTTIME:   133.6233
&gt;&gt;&gt; Smallest outlier flux &gt;= 0 NIGHTTIME:  35.22051
&gt;&gt;&gt; Largest outlier flux &lt; 0 NIGHTTIME:    -14.51354
&gt;&gt;&gt; Smallest outlier flux &lt; 0 NIGHTTIME:   -282.19820000000004
</pre></div>
</div>
<img alt="../../_images/de7e276413816db4767a917f0b91815bfea2d28e76e25d24db259f588ef4b713.png" src="../../_images/de7e276413816db4767a917f0b91815bfea2d28e76e25d24db259f588ef4b713.png" />
<img alt="../../_images/9aaff207da2019dc2ab58135ecf71e3f957741db860df2b7f9477432c56054ee.png" src="../../_images/9aaff207da2019dc2ab58135ecf71e3f957741db860df2b7f9477432c56054ee.png" />
<img alt="../../_images/3876ce6ae5fab46da62bf85da6c4788c8631d8b1aab39a106ffb64df97176638.png" src="../../_images/3876ce6ae5fab46da62bf85da6c4788c8631d8b1aab39a106ffb64df97176638.png" />
</div>
</div>
</br></br></section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="level-3-2-outlier-detection">
<h1>Level-3.2: <strong>OUTLIER DETECTION</strong><a class="headerlink" href="#level-3-2-outlier-detection" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>Running an outlier test creates a <em>preview</em> plot of the results</p></li>
<li><p>If the output looks as desired, run <code class="docutils literal notranslate"><span class="pre">fpc.level32_addflag()</span></code> cell below the preview to accept the results you see in the plot</p></li>
<li><p>All subsequent tests will then be based on these results</p></li>
<li><p>This means that each test is run on the data already filtered by the previous test</p></li>
<li><p>Each test creates its own quality flag</p></li>
<li><p>At the end of Level-3.2, an overall quality flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> is created that combines all of the individual flags into one single flag</p></li>
</ul>
</br><section id="plot-time-series">
<h2>Plot time series<a class="headerlink" href="#plot-time-series" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">(quality-controlled Level-3.1 version of </span><span class="si">{</span><span class="n">fpc</span><span class="o">.</span><span class="n">fluxcol</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NEE_L3.1_QCF 
(quality-controlled Level-3.1 version of FC)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TimeSeries(series=fpc.fpc_df[fpc.filteredseries.name]).plot_interactive()</span>
<span class="n">TimeSeries</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e8696e297599a39d9a30f18ae496b8913c2b6d0faea49325b28ac39c4949ca6f.png" src="../../_images/e8696e297599a39d9a30f18ae496b8913c2b6d0faea49325b28ac39c4949ca6f.png" />
</div>
</div>
</br></section>
<section id="initiate-calculations">
<h2>Initiate calculations<a class="headerlink" href="#initiate-calculations" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_stepwise_outlier_detection</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-absolute-limits">
<h2>Outlier flag: <strong>Absolute limits</strong><a class="headerlink" href="#outlier-flag-absolute-limits" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>remove values outside a physically plausible range</p></li>
<li><p>typical value for CO2 flux <code class="docutils literal notranslate"><span class="pre">FC</span></code>: +/-50 µmol m-2 s-1</p></li>
<li><p>typical value for latent evaporation flux <code class="docutils literal notranslate"><span class="pre">LE</span></code>: +800 / -50 W m-2</p></li>
<li><p>typical value for sensible heat flux <code class="docutils literal notranslate"><span class="pre">H</span></code>: +400 / -200 W m-2</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.absolutelimits import AbsoluteLimits</span>
<span class="c1"># help(AbsoluteLimits)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MIN</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span>
<span class="n">MAX</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">level32_flag_outliers_abslim_test</span><span class="p">(</span><span class="n">minval</span><span class="o">=</span><span class="n">MIN</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">MAX</span><span class="p">,</span> <span class="n">showplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[AbsoluteLimits]  running AbsoluteLimits ...
</pre></div>
</div>
<img alt="../../_images/27bf7fe2becbb883efa4b58c8518d4edb60003c6d019cea9d65e0f86ab3459d3.png" src="../../_images/27bf7fe2becbb883efa4b58c8518d4edb60003c6d019cea9d65e0f86ab3459d3.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_addflag</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>++Added flag column FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST to flag data
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-manual-flag">
<h2>Outlier flag: <strong>Manual flag</strong><a class="headerlink" href="#outlier-flag-manual-flag" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>The interactive plot can be used to determine the exact start and end of time ranges or data points that need to be removed, e.g. due to known instrument failure</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.manualremoval import ManualRemoval</span>
<span class="c1"># help(ManualRemoval)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32.showplot_cleaned(interactive=True)  # True or False</span>
<span class="c1"># fpc.level32.showplot_cleaned(interactive=False)  # True or False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Removes date range between two datetimes (inclusive)</span>
<span class="n">REMOVE_DATES</span> <span class="o">=</span> <span class="p">[</span>    
    <span class="p">[</span><span class="s1">&#39;2008-12-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2009-05-01&#39;</span><span class="p">]</span>
<span class="p">]</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">level32_flag_manualremoval_test</span><span class="p">(</span>
    <span class="n">remove_dates</span><span class="o">=</span><span class="n">REMOVE_DATES</span><span class="p">,</span>
    <span class="n">showplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[ManualRemoval]  running ManualRemoval ...
</pre></div>
</div>
<img alt="../../_images/66b7f87c11b1276f093878db62c1c17de27055cd3e6aae994be1b549cf165fc4.png" src="../../_images/66b7f87c11b1276f093878db62c1c17de27055cd3e6aae994be1b549cf165fc4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_addflag</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>++Added flag column FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST to flag data
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32.showplot_cleaned(interactive=True)  # True or False</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-hampel-filter-separate-for-daytime-and-nighttime">
<h2>Outlier flag: <strong>Hampel filter</strong>, separate for daytime and nighttime<a class="headerlink" href="#outlier-flag-hampel-filter-separate-for-daytime-and-nighttime" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Recommended filter</p></li>
<li><p>Is slow compared to other filters:</p>
<ul>
<li><p>tested with 1 year of 30MIN time resolution data and it needed approx. 43 seconds on a fast desktop computer</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.hampel import Hampel</span>
<span class="c1"># help(Hampel)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">WINDOW_LENGTH</span> <span class="o">=</span> <span class="mi">48</span> <span class="o">*</span> <span class="mi">13</span>
<span class="n">N_SIGMA_DT</span> <span class="o">=</span> <span class="mf">4.5</span>
<span class="n">N_SIGMA_NT</span> <span class="o">=</span> <span class="mf">4.5</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">level32_flag_outliers_hampel_dtnt_test</span><span class="p">(</span><span class="n">window_length</span><span class="o">=</span><span class="n">WINDOW_LENGTH</span><span class="p">,</span> <span class="n">n_sigma_dt</span><span class="o">=</span><span class="n">N_SIGMA_DT</span><span class="p">,</span> <span class="n">n_sigma_nt</span><span class="o">=</span><span class="n">N_SIGMA_NT</span><span class="p">,</span>
                                           <span class="n">showplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[HampelDaytimeNighttime]  running HampelDaytimeNighttime ...
ITERATION#1: Total found outliers: 1655 (daytime+nighttime), 1022 (daytime), 633 (nighttime)
ITERATION#2: Total found outliers: 119 (daytime+nighttime), 85 (daytime), 34 (nighttime)
ITERATION#3: Total found outliers: 13 (daytime+nighttime), 11 (daytime), 2 (nighttime)
ITERATION#4: Total found outliers: 0 (daytime+nighttime), 0 (daytime), 0 (nighttime)
CPU times: total: 1min 49s
Wall time: 1min 51s
</pre></div>
</div>
<img alt="../../_images/848ac31dbcdbbfc504d0e237636cd13b82487366da08ac91032b8f0a278050b2.png" src="../../_images/848ac31dbcdbbfc504d0e237636cd13b82487366da08ac91032b8f0a278050b2.png" />
<img alt="../../_images/946626323e9f225185584b27418b30fc9cf79d0f23a275ffcf76c1332ce00dc5.png" src="../../_images/946626323e9f225185584b27418b30fc9cf79d0f23a275ffcf76c1332ce00dc5.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_addflag</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>++Added flag column FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST to flag data
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-z-score-across-all-data">
<h2>Outlier flag: <strong>z-score across all data</strong><a class="headerlink" href="#outlier-flag-z-score-across-all-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.zscore import zScore</span>
<span class="c1"># help(zScore)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># THRES_ZSCORE = 6</span>
<span class="c1"># fpc.level32_flag_outliers_zscore_test(thres_zscore=THRES_ZSCORE, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-hampel-filter">
<h2>Outlier flag: <strong>Hampel filter</strong><a class="headerlink" href="#outlier-flag-hampel-filter" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Recommended filter</p></li>
<li><p>Is slow compared to other filters:</p>
<ul>
<li><p>tested with 1 year of 30MIN time resolution data and it needed approx. 33 seconds on a fast desktop computer</p></li>
<li><p>tested with 19 years of 30MIN time resolution data and it needed approx. 20 minutes on a fast desktop computer</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.hampel import Hampel</span>
<span class="c1"># help(Hampel)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># WINDOW_LENGTH = 48 * 13</span>
<span class="c1"># N_SIGMA = 6</span>
<span class="c1"># %%time</span>
<span class="c1"># fpc.level32_flag_outliers_hampel_test(window_length=WINDOW_LENGTH, n_sigma=N_SIGMA, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-z-score-over-all-data-separate-for-daytime-and-nighttime">
<h2>Outlier flag: <strong>z-score over all data</strong>, separate for daytime and nighttime<a class="headerlink" href="#outlier-flag-z-score-over-all-data-separate-for-daytime-and-nighttime" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.zscore import zScoreDaytimeNighttime</span>
<span class="c1"># help(zScoreDaytimeNighttime)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># THRES_ZSCORE = 5</span>
<span class="c1"># fpc.level32_flag_outliers_zscore_dtnt_test(thres_zscore=THRES_ZSCORE, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-rolling-z-score-over-all-data">
<h2>Outlier flag: <strong>Rolling z-score over all data</strong><a class="headerlink" href="#outlier-flag-rolling-z-score-over-all-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.zscore import zScoreRolling</span>
<span class="c1"># help(zScoreRolling)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># THRES_ZSCORE = 5.5</span>
<span class="c1"># WINSIZE = 48 * 13</span>
<span class="c1"># fpc.level32_flag_outliers_zscore_rolling_test(winsize=WINSIZE, thres_zscore=THRES_ZSCORE, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-local-standard-deviation-with-rolling-median-and-rolling-standard-deviation">
<h2>Outlier flag: <strong>Local standard deviation</strong>, with rolling median and <em>rolling</em> standard deviation<a class="headerlink" href="#outlier-flag-local-standard-deviation-with-rolling-median-and-rolling-standard-deviation" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.localsd import LocalSD</span>
<span class="c1"># help(LocalSD)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># N_SD = 4.5</span>
<span class="c1"># WINSIZE = 48 * 9</span>
<span class="c1"># fpc.level32_flag_outliers_localsd_test(n_sd=N_SD, winsize=WINSIZE, constant_sd=False, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-local-standard-deviation-with-rolling-median-and-constant-standard-deviation">
<h2>Outlier flag: <strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation<a class="headerlink" href="#outlier-flag-local-standard-deviation-with-rolling-median-and-constant-standard-deviation" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>keep standard deviation constant by setting parameter <code class="docutils literal notranslate"><span class="pre">constant_sd=True</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># N_SD = 3.5</span>
<span class="c1"># WINSIZE = 48 * 13</span>
<span class="c1"># fpc.level32_flag_outliers_localsd_test(n_sd=N_SD, winsize=WINSIZE, constant_sd=True, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-increments-z-score">
<h2>Outlier flag: <strong>Increments z-score</strong><a class="headerlink" href="#outlier-flag-increments-z-score" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.incremental import zScoreIncrements</span>
<span class="c1"># help(zScoreIncrements)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># THRES_ZSCORE = 4</span>
<span class="c1"># fpc.level32_flag_outliers_increments_zcore_test(thres_zscore=THRES_ZSCORE, showplot=True, verbose=True, repeat=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-local-outlier-factor-daytime-nighttime">
<h2>Outlier flag: <strong>Local outlier factor</strong>, daytime/nighttime<a class="headerlink" href="#outlier-flag-local-outlier-factor-daytime-nighttime" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Test is run separately for daytime and nighttime data</p></li>
<li><p>Description of local outlier factor: <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.LocalOutlierFactor.html">here</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.lof import LocalOutlierFactorDaytimeNighttime</span>
<span class="c1"># help(LocalOutlierFactorDaytimeNighttime)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># N_NEIGHBORS = None</span>
<span class="c1"># CONTAMINATION = None</span>
<span class="c1"># fpc.level32_flag_outliers_lof_dtnt_test(n_neighbors=N_NEIGHBORS, contamination=CONTAMINATION, showplot=True, verbose=True, repeat=False, n_jobs=-1)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-local-outlier-factor">
<h2>Outlier flag: <strong>Local outlier factor</strong><a class="headerlink" href="#outlier-flag-local-outlier-factor" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Test is run across all data</p></li>
<li><p>Description of local outlier factor: <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.neighbors.LocalOutlierFactor.html">here</a></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.lof import LocalOutlierFactorAllData</span>
<span class="c1"># help(LocalOutlierFactorAllData)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># N_NEIGHBORS = 24</span>
<span class="c1"># CONTAMINATION = None</span>
<span class="c1"># fpc.level32_flag_outliers_lof_test(n_neighbors=N_NEIGHBORS, contamination=CONTAMINATION, showplot=True, verbose=True, repeat=False, n_jobs=-1)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-absolute-limits-separate-for-daytime-and-nighttime-data">
<h2>Outlier flag: <strong>Absolute limits</strong>, separate for daytime and nighttime data<a class="headerlink" href="#outlier-flag-absolute-limits-separate-for-daytime-and-nighttime-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.absolutelimits import AbsoluteLimitsDaytimeNighttime</span>
<span class="c1"># help(AbsoluteLimitsDaytimeNighttime)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># MIN_DT = -50</span>
<span class="c1"># MAX_DT = 50</span>
<span class="c1"># MIN_NT = -25</span>
<span class="c1"># MAX_NT = 25</span>
<span class="c1"># fpc.level32_flag_outliers_abslim_dtnt_test(daytime_minmax=[MIN_DT, MAX_DT], nighttime_minmax=[MIN_NT, MAX_NT], showplot=True, verbose=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="outlier-flag-trim-nighttime-flux-data">
<h2>Outlier flag: <strong>Trim nighttime flux data</strong><a class="headerlink" href="#outlier-flag-trim-nighttime-flux-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.pkgs.outlierdetection.trim import TrimLow</span>
<span class="c1"># help(TrimLow)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_flag_outliers_trim_low_test(trim_nighttime=True, lower_limit=-5, showplot=True, verbose=True)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_addflag()</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="finalize-level-3-2-calculate-overall-quality-flag-so-far">
<h2><strong>Finalize Level-3.2</strong>: Calculate overall quality flag (so far)<a class="headerlink" href="#finalize-level-3-2-calculate-overall-quality-flag-so-far" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">finalize_level32</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>++Added new column FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST.
++Added new column FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST.
++Added new column FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST.
++Added new column SUM_L3.2_NEE_L3.1_HARDFLAGS.
++Added new column SUM_L3.2_NEE_L3.1_SOFTFLAGS.
++Added new column SUM_L3.2_NEE_L3.1_FLAGS.
++Added new column FLAG_L3.2_NEE_L3.1_QCF.
++Added new column NEE_L3.1_L3.2_QCF.
++Added new column NEE_L3.1_L3.2_QCF0.
</pre></div>
</div>
</div>
</div>
</br><section id="available-level-3-2-variables">
<h3>Available <code class="docutils literal notranslate"><span class="pre">Level-3.2</span></code> variables<a class="headerlink" href="#available-level-3-2-variables" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This shows all available Level-3.2 variables for this flux</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;L3.2&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST&#39;,
 &#39;FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST&#39;,
 &#39;FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST&#39;,
 &#39;SUM_L3.2_NEE_L3.1_HARDFLAGS&#39;,
 &#39;SUM_L3.2_NEE_L3.1_SOFTFLAGS&#39;,
 &#39;SUM_L3.2_NEE_L3.1_FLAGS&#39;,
 &#39;FLAG_L3.2_NEE_L3.1_QCF&#39;,
 &#39;NEE_L3.1_L3.2_QCF&#39;,
 &#39;NEE_L3.1_L3.2_QCF0&#39;]
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="plot-filtered-flux-after-level-3-2">
<h3>Plot filtered flux after Level-3.2<a class="headerlink" href="#plot-filtered-flux-after-level-3-2" title="Link to this heading">#</a></h3>
<p>In the four panels, from left to right:</p>
<ul class="simple">
<li><p>flux after Level-3.1, before outlier removal</p></li>
<li><p>flux after Level-3.2, after outlier removal</p></li>
<li><p>sum of the individual test flags</p></li>
<li><p>overall flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> (quality control flag), where <code class="docutils literal notranslate"><span class="pre">0</span></code>=best quality, <code class="docutils literal notranslate"><span class="pre">1</span></code>=medium quality, <code class="docutils literal notranslate"><span class="pre">2</span></code>=bad quality</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_qcf</span><span class="o">.</span><span class="n">showplot_qcf_heatmaps</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/df5a2095060c14aadafdfb1187cd70bda4a1d00e8f89f6b8183149d1e7cb3d89.png" src="../../_images/df5a2095060c14aadafdfb1187cd70bda4a1d00e8f89f6b8183149d1e7cb3d89.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TimeSeries</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="c1"># TimeSeries(series=fpc.filteredseries).plot_interactive()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/200656a3b93616cf0a37e10e22b7fb941f2c1cc4d00f09ed9213ce5ba5d37a28.png" src="../../_images/200656a3b93616cf0a37e10e22b7fb941f2c1cc4d00f09ed9213ce5ba5d37a28.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fpc.level32_qcf.showplot_qcf_timeseries()</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="id3">
<h3>Reports<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_qcf</span><span class="o">.</span><span class="n">report_qcf_evolution</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
QCF FLAG EVOLUTION
========================================
This output shows the evolution of the QCF overall quality flag
when test flags are applied sequentially to the variable NEE_L3.1.

Number of NEE_L3.1 records before QC: 128967
+++ FLAG_L2_FC_MISSING_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 128967 (100.00%) / flag 1: 0 (0.00%) / flag 2: 0 (0.00%)
+++ FLAG_L2_FC_SSITC_TEST rejected 58965 values (+45.72%)      TOTALS: flag 0: 46234 (35.85%) / flag 1: 23768 (18.43%) / flag 2: 58965 (45.72%)
+++ FLAG_L2_FC_SCF_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 46234 (35.85%) / flag 1: 23768 (18.43%) / flag 2: 58965 (45.72%)
+++ FLAG_L2_FC_SIGNAL_STRENGTH_TEST rejected 146 values (+0.11%)      TOTALS: flag 0: 46167 (35.80%) / flag 1: 23689 (18.37%) / flag 2: 59111 (45.83%)
+++ FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST rejected 8 values (+0.01%)      TOTALS: flag 0: 46162 (35.79%) / flag 1: 23686 (18.37%) / flag 2: 59119 (45.84%)
+++ FLAG_L2_FC_CO2_VM97_DROPOUT_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 46162 (35.79%) / flag 1: 23686 (18.37%) / flag 2: 59119 (45.84%)
+++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST rejected 680 values (+0.53%)      TOTALS: flag 0: 45931 (35.61%) / flag 1: 23237 (18.02%) / flag 2: 59799 (46.37%)
+++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 45931 (35.61%) / flag 1: 23237 (18.02%) / flag 2: 59799 (46.37%)
+++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST rejected 1787 values (+1.39%)      TOTALS: flag 0: 44865 (34.79%) / flag 1: 22516 (17.46%) / flag 2: 61586 (47.75%)

In total, 61586 (47.75%) of the available records were rejected in this step.
INFO Rejected DAYTIME records where QCF flag &gt;= 2
INFO Rejected NIGHTTIME records where QCF flag &gt;= 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_qcf</span><span class="o">.</span><span class="n">report_qcf_series</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
SUMMARY: FLAG_L3.2_NEE_L3.1_QCF, QCF FLAG FOR NEE_L3.1
========================================
Between 2017-01-01 00:15 and 2024-12-31 23:45 ...
    Total flux records BEFORE quality checks: 128967 (91.95% of potential)
    Available flux records AFTER quality checks: 67381 (52.25% of total)
    Rejected flux records: 61586 (47.75% of total)
    Potential flux records: 140256
    Potential flux records missed: 11289 (8.05% of potential)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">level32_qcf</span><span class="o">.</span><span class="n">report_qcf_flags</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
REPORT: FLAGS INCL. MISSING VALUES
========================================
Stats with missing values in the dataset
FLAG_L2_FC_MISSING_TEST:
    OVERALL flag 0.0: 128967 values (91.95%)  
    OVERALL flag 2.0: 11289 values (8.05%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (93.61%)  
    DAYTIME flag 2.0: 4405 values (6.39%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (90.35%)  
    NIGHTTIME flag 2.0: 6884 values (9.65%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SSITC_TEST:
    OVERALL flag 0.0: 46234 values (32.96%)  
    OVERALL flag 1.0: 53403 values (38.08%)  
    OVERALL flag 2.0: 29330 values (20.91%)  
    OVERALL flag missing: 11289 values (8.05%)  

    DAYTIME flag 0.0: 27642 values (40.11%)  
    DAYTIME flag 1.0: 23768 values (34.49%)  
    DAYTIME flag 2.0: 13105 values (19.01%)  
    DAYTIME flag missing: 4405 values (6.39%)  

    NIGHTTIME flag 0.0: 18592 values (26.06%)  
    NIGHTTIME flag 1.0: 29635 values (41.54%)  
    NIGHTTIME flag 2.0: 16225 values (22.74%)  
    NIGHTTIME flag missing: 6884 values (9.65%)  

FLAG_L2_FC_SCF_TEST:
    OVERALL flag 0.0: 128947 values (91.94%)  
    OVERALL flag 1.0: 19 values (0.01%)  
    OVERALL flag 2.0: 1 values (0.00%)  
    OVERALL flag missing: 11289 values (8.05%)  

    DAYTIME flag 0.0: 64509 values (93.60%)  
    DAYTIME flag 1.0: 5 values (0.01%)  
    DAYTIME flag 2.0: 1 values (0.00%)  
    DAYTIME flag missing: 4405 values (6.39%)  

    NIGHTTIME flag 0.0: 64438 values (90.33%)  
    NIGHTTIME flag 1.0: 14 values (0.02%)  
    NIGHTTIME flag missing: 6884 values (9.65%)  

FLAG_L2_FC_SIGNAL_STRENGTH_TEST:
    OVERALL flag 0.0: 128903 values (91.91%)  
    OVERALL flag 2.0: 1876 values (1.34%)  
    OVERALL flag missing: 9477 values (6.76%)  

    DAYTIME flag 0.0: 64522 values (93.62%)  
    DAYTIME flag 2.0: 704 values (1.02%)  
    DAYTIME flag missing: 3694 values (5.36%)  

    NIGHTTIME flag 0.0: 64381 values (90.25%)  
    NIGHTTIME flag 2.0: 1172 values (1.64%)  
    NIGHTTIME flag missing: 5783 values (8.11%)  

FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST:
    OVERALL flag 0.0: 132143 values (94.22%)  
    OVERALL flag 2.0: 34 values (0.02%)  
    OVERALL flag missing: 8079 values (5.76%)  

    DAYTIME flag 0.0: 65706 values (95.34%)  
    DAYTIME flag 2.0: 7 values (0.01%)  
    DAYTIME flag missing: 3207 values (4.65%)  

    NIGHTTIME flag 0.0: 66437 values (93.13%)  
    NIGHTTIME flag 2.0: 27 values (0.04%)  
    NIGHTTIME flag missing: 4872 values (6.83%)  

FLAG_L2_FC_CO2_VM97_DROPOUT_TEST:
    OVERALL flag 0.0: 132177 values (94.24%)  
    OVERALL flag missing: 8079 values (5.76%)  

    DAYTIME flag 0.0: 65713 values (95.35%)  
    DAYTIME flag missing: 3207 values (4.65%)  

    NIGHTTIME flag 0.0: 66464 values (93.17%)  
    NIGHTTIME flag missing: 4872 values (6.83%)  

FLAG_L2_FC_QCF:
    OVERALL flag 0.0: 46162 values (32.91%)  
    OVERALL flag 1.0: 23686 values (16.89%)  
    OVERALL flag 2.0: 70408 values (50.20%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 27614 values (40.07%)  
    DAYTIME flag 1.0: 23686 values (34.37%)  
    DAYTIME flag 2.0: 17620 values (25.57%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 18548 values (26.00%)  
    NIGHTTIME flag 2.0: 52788 values (74.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST:
    OVERALL flag 0.0: 139576 values (99.52%)  
    OVERALL flag 2.0: 680 values (0.48%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 68265 values (99.05%)  
    DAYTIME flag 2.0: 655 values (0.95%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 71311 values (99.96%)  
    NIGHTTIME flag 2.0: 25 values (0.04%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST:
    OVERALL flag 0.0: 140256 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 68920 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 71336 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST:
    OVERALL flag 0.0: 138469 values (98.73%)  
    OVERALL flag 2.0: 1787 values (1.27%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 67745 values (98.30%)  
    DAYTIME flag 2.0: 1175 values (1.70%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 70724 values (99.14%)  
    NIGHTTIME flag 2.0: 612 values (0.86%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF:
    OVERALL flag 0.0: 44865 values (31.99%)  
    OVERALL flag 1.0: 22516 values (16.05%)  
    OVERALL flag 2.0: 72875 values (51.96%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 26954 values (39.11%)  
    DAYTIME flag 1.0: 22516 values (32.67%)  
    DAYTIME flag 2.0: 19450 values (28.22%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 17911 values (25.11%)  
    NIGHTTIME flag 2.0: 53425 values (74.89%)  
    NIGHTTIME flag missing: 0 values (0.00%)  


========================================
REPORT: FLAGS FOR AVAILABLE RECORDS
========================================
Stats after removal of missing values
FLAG_L2_FC_MISSING_TEST:
    OVERALL flag 0.0: 128967 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SSITC_TEST:
    OVERALL flag 0.0: 46234 values (35.85%)  
    OVERALL flag 1.0: 53403 values (41.41%)  
    OVERALL flag 2.0: 29330 values (22.74%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 27642 values (42.85%)  
    DAYTIME flag 1.0: 23768 values (36.84%)  
    DAYTIME flag 2.0: 13105 values (20.31%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 18592 values (28.85%)  
    NIGHTTIME flag 1.0: 29635 values (45.98%)  
    NIGHTTIME flag 2.0: 16225 values (25.17%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SCF_TEST:
    OVERALL flag 0.0: 128947 values (99.98%)  
    OVERALL flag 1.0: 19 values (0.01%)  
    OVERALL flag 2.0: 1 values (0.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64509 values (99.99%)  
    DAYTIME flag 1.0: 5 values (0.01%)  
    DAYTIME flag 2.0: 1 values (0.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64438 values (99.98%)  
    NIGHTTIME flag 1.0: 14 values (0.02%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SIGNAL_STRENGTH_TEST:
    OVERALL flag 0.0: 128382 values (99.55%)  
    OVERALL flag 2.0: 585 values (0.45%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64319 values (99.70%)  
    DAYTIME flag 2.0: 196 values (0.30%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64063 values (99.40%)  
    NIGHTTIME flag 2.0: 389 values (0.60%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST:
    OVERALL flag 0.0: 128934 values (99.97%)  
    OVERALL flag 2.0: 33 values (0.03%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64509 values (99.99%)  
    DAYTIME flag 2.0: 6 values (0.01%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64425 values (99.96%)  
    NIGHTTIME flag 2.0: 27 values (0.04%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_CO2_VM97_DROPOUT_TEST:
    OVERALL flag 0.0: 128967 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_QCF:
    OVERALL flag 0.0: 46162 values (35.79%)  
    OVERALL flag 1.0: 23686 values (18.37%)  
    OVERALL flag 2.0: 59119 values (45.84%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 27614 values (42.80%)  
    DAYTIME flag 1.0: 23686 values (36.71%)  
    DAYTIME flag 2.0: 13215 values (20.48%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 18548 values (28.78%)  
    NIGHTTIME flag 2.0: 45904 values (71.22%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST:
    OVERALL flag 0.0: 128287 values (99.47%)  
    OVERALL flag 2.0: 680 values (0.53%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 63860 values (98.98%)  
    DAYTIME flag 2.0: 655 values (1.02%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64427 values (99.96%)  
    NIGHTTIME flag 2.0: 25 values (0.04%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST:
    OVERALL flag 0.0: 128967 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST:
    OVERALL flag 0.0: 127180 values (98.61%)  
    OVERALL flag 2.0: 1787 values (1.39%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 63340 values (98.18%)  
    DAYTIME flag 2.0: 1175 values (1.82%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 63840 values (99.05%)  
    NIGHTTIME flag 2.0: 612 values (0.95%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF:
    OVERALL flag 0.0: 44865 values (34.79%)  
    OVERALL flag 1.0: 22516 values (17.46%)  
    OVERALL flag 2.0: 61586 values (47.75%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 26954 values (41.78%)  
    DAYTIME flag 1.0: 22516 values (34.90%)  
    DAYTIME flag 2.0: 15045 values (23.32%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 17911 values (27.79%)  
    NIGHTTIME flag 2.0: 46541 values (72.21%)  
    NIGHTTIME flag missing: 0 values (0.00%)  
</pre></div>
</div>
</div>
</div>
</br></section>
</section>
<section id="save-level-3-2-results-to-file">
<h2>Save Level-3.2 results to file<a class="headerlink" href="#save-level-3-2-results-to-file" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>If needed, save results so far (input data and all created variables, e.g. flags and filtered fluxes) to a file</p></li>
<li><p>This can be useful if e.g. USTAR filtering is not needed and gap-filling is done elsewhere (ReddyProc…)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># results_df = fpc.get_data()</span>
<span class="c1"># filename = &quot;51.1_FluxProcessingChain_after-L3.3_NEE&quot;</span>
<span class="c1"># results_df.to_csv(f&quot;{filename}.csv&quot;, index=True)</span>
<span class="c1"># save_parquet(data=results_df, filename=filename)</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="level-3-3-ustar-filtering">
<h1>Level-3.3: <strong>USTAR FILTERING</strong><a class="headerlink" href="#level-3-3-ustar-filtering" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>Daytime and nighttime data are filtered based on USTAR thresholds</p></li>
<li><p>Example USTAR thresholds from the analysis done by FLUXNET (2005-2023) for the intensively managed grassland <a class="reference external" href="https://www.swissfluxnet.ethz.ch/index.php/sites/site-info-ch-cha/">CH-CHA, Chamau</a>:</p>
<ul>
<li><p>CUT_16: <code class="docutils literal notranslate"><span class="pre">0.0529445</span></code></p></li>
<li><p>CUT_50: <code class="docutils literal notranslate"><span class="pre">0.0698982</span></code></p></li>
<li><p>CUT_84: <code class="docutils literal notranslate"><span class="pre">0.0928408</span></code></p></li>
</ul>
</li>
</ul>
<div class="alert alert-block alert-danger">
    No USTAR filtering for: <b>H, LE, ET and FH2O.</b> 
</div><blockquote>
<div><p>The USTAR filtering is not applied to H and LE, because it has not been proved that when there are CO2 advective fluxes, these also impact energy fluxes, specifically due to the fact that when advection is in general large (nighttime), energy fluxes are small.</p>
</div></blockquote>
<p>source: <a class="reference external" href="https://doi.org/10.1038/s41597-020-0534-3">Pastorello et al. (2020). The FLUXNET2015 dataset and the ONEFlux processing pipeline for eddy covariance data</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">USTAR_SCENARIOS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CUT_50&#39;</span><span class="p">]</span>
<span class="n">USTAR_THRESHOLDS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3</span><span class="p">]</span>
<span class="c1"># USTAR_SCENARIOS = [&#39;CUT_16&#39;, &#39;CUT_50&#39;, &#39;CUT_84&#39;]</span>
<span class="c1"># USTAR_THRESHOLDS = [0.0529445, 0.0698982, 0.0928408]</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">level33_constant_ustar</span><span class="p">(</span><span class="n">thresholds</span><span class="o">=</span><span class="n">USTAR_THRESHOLDS</span><span class="p">,</span>
                           <span class="n">threshold_labels</span><span class="o">=</span><span class="n">USTAR_SCENARIOS</span><span class="p">,</span>
                           <span class="n">showplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[FlagSingleConstantUstarThreshold]  running FlagSingleConstantUstarThreshold ...
Total found outliers for USTAR threshold _L3.3_CUT_50 0.3: 42827 values
</pre></div>
</div>
</div>
</div>
</br><section id="finalize-level-3-3-caculate-overall-final-quality-flag">
<h2><strong>Finalize Level-3.3</strong>: Caculate overall final quality flag<a class="headerlink" href="#finalize-level-3-3-caculate-overall-final-quality-flag" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Finalize: stores results for each USTAR scenario in a dict</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">finalize_level33</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculating overall quality flag QCF for USTAR scenario CUT_50...
++Added new column FLAG_L3.3_CUT_50_NEE_L3.1_USTAR_TEST.
++Added new column SUM_L3.3_CUT_50_NEE_L3.1_HARDFLAGS.
++Added new column SUM_L3.3_CUT_50_NEE_L3.1_SOFTFLAGS.
++Added new column SUM_L3.3_CUT_50_NEE_L3.1_FLAGS.
++Added new column FLAG_L3.3_CUT_50_NEE_L3.1_QCF.
++Added new column NEE_L3.1_L3.3_CUT_50_QCF.
++Added new column NEE_L3.1_L3.3_CUT_50_QCF0.
</pre></div>
</div>
</div>
</div>
</br><section id="available-level-3-3-variables">
<h3>Available <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code> variables<a class="headerlink" href="#available-level-3-3-variables" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>This shows all available Level-3.3 variables for this flux</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;L3.3&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;FLAG_L3.3_CUT_50_NEE_L3.1_USTAR_TEST&#39;,
 &#39;SUM_L3.3_CUT_50_NEE_L3.1_HARDFLAGS&#39;,
 &#39;SUM_L3.3_CUT_50_NEE_L3.1_SOFTFLAGS&#39;,
 &#39;SUM_L3.3_CUT_50_NEE_L3.1_FLAGS&#39;,
 &#39;FLAG_L3.3_CUT_50_NEE_L3.1_QCF&#39;,
 &#39;NEE_L3.1_L3.3_CUT_50_QCF&#39;,
 &#39;NEE_L3.1_L3.3_CUT_50_QCF0&#39;]
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="plot-filtered-flux-after-level-3-3">
<h3>Plot filtered flux after Level-3.3<a class="headerlink" href="#plot-filtered-flux-after-level-3-3" title="Link to this heading">#</a></h3>
<p>In the four panels, from left to right:</p>
<ul class="simple">
<li><p>flux after Level-3.1, before outlier removal and USTAR filtering</p></li>
<li><p>flux after Level-3.3, after outlier removal and USTAR filtering</p></li>
<li><p>sum of the individual test flags</p></li>
<li><p>overall flag <code class="docutils literal notranslate"><span class="pre">QCF</span></code> (quality control flag), where <code class="docutils literal notranslate"><span class="pre">0</span></code>=best quality, <code class="docutils literal notranslate"><span class="pre">1</span></code>=medium quality, <code class="docutils literal notranslate"><span class="pre">2</span></code>=bad quality</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># TimeSeries(series=fpc.fpc_df[fluxhq]).plot_interactive()</span>
    <span class="c1"># TimeSeries(series=fpc.fpc_df[FLUXVAR33QCF[key].name]).plot()</span>
    <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">showplot_qcf_heatmaps</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/319420dc042b4bc0806c2eb919ad0b44d24d1a276f387a8494614b397718dd12.png" src="../../_images/319420dc042b4bc0806c2eb919ad0b44d24d1a276f387a8494614b397718dd12.png" />
</div>
</div>
</br></section>
<section id="id4">
<h3>Reports<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">report_qcf_evolution</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
QCF FLAG EVOLUTION
========================================
This output shows the evolution of the QCF overall quality flag
when test flags are applied sequentially to the variable NEE_L3.1.

Number of NEE_L3.1 records before QC: 128967
+++ FLAG_L2_FC_MISSING_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 128967 (100.00%) / flag 1: 0 (0.00%) / flag 2: 0 (0.00%)
+++ FLAG_L2_FC_SSITC_TEST rejected 58965 values (+45.72%)      TOTALS: flag 0: 46234 (35.85%) / flag 1: 23768 (18.43%) / flag 2: 58965 (45.72%)
+++ FLAG_L2_FC_SCF_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 46234 (35.85%) / flag 1: 23768 (18.43%) / flag 2: 58965 (45.72%)
+++ FLAG_L2_FC_SIGNAL_STRENGTH_TEST rejected 146 values (+0.11%)      TOTALS: flag 0: 46167 (35.80%) / flag 1: 23689 (18.37%) / flag 2: 59111 (45.83%)
+++ FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST rejected 8 values (+0.01%)      TOTALS: flag 0: 46162 (35.79%) / flag 1: 23686 (18.37%) / flag 2: 59119 (45.84%)
+++ FLAG_L2_FC_CO2_VM97_DROPOUT_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 46162 (35.79%) / flag 1: 23686 (18.37%) / flag 2: 59119 (45.84%)
+++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST rejected 680 values (+0.53%)      TOTALS: flag 0: 45931 (35.61%) / flag 1: 23237 (18.02%) / flag 2: 59799 (46.37%)
+++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST rejected 0 values (+0.00%)      TOTALS: flag 0: 45931 (35.61%) / flag 1: 23237 (18.02%) / flag 2: 59799 (46.37%)
+++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST rejected 1787 values (+1.39%)      TOTALS: flag 0: 44865 (34.79%) / flag 1: 22516 (17.46%) / flag 2: 61586 (47.75%)
+++ FLAG_L3.3_CUT_50_NEE_L3.1_USTAR_TEST rejected 14372 values (+11.14%)      TOTALS: flag 0: 36700 (28.46%) / flag 1: 16309 (12.65%) / flag 2: 75958 (58.90%)

In total, 75958 (58.90%) of the available records were rejected in this step.
INFO Rejected DAYTIME records where QCF flag &gt;= 2
INFO Rejected NIGHTTIME records where QCF flag &gt;= 1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">report_qcf_series</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
SUMMARY: FLAG_L3.3_CUT_50_NEE_L3.1_QCF, QCF FLAG FOR NEE_L3.1
========================================
Between 2017-01-01 00:15 and 2024-12-31 23:45 ...
    Total flux records BEFORE quality checks: 128967 (91.95% of potential)
    Available flux records AFTER quality checks: 53009 (41.10% of total)
    Rejected flux records: 75958 (58.90% of total)
    Potential flux records: 140256
    Potential flux records missed: 11289 (8.05% of potential)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">fpc</span><span class="o">.</span><span class="n">level33_qcf</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">report_qcf_flags</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>========================================
REPORT: FLAGS INCL. MISSING VALUES
========================================
Stats with missing values in the dataset
FLAG_L2_FC_MISSING_TEST:
    OVERALL flag 0.0: 128967 values (91.95%)  
    OVERALL flag 2.0: 11289 values (8.05%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (93.61%)  
    DAYTIME flag 2.0: 4405 values (6.39%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (90.35%)  
    NIGHTTIME flag 2.0: 6884 values (9.65%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SSITC_TEST:
    OVERALL flag 0.0: 46234 values (32.96%)  
    OVERALL flag 1.0: 53403 values (38.08%)  
    OVERALL flag 2.0: 29330 values (20.91%)  
    OVERALL flag missing: 11289 values (8.05%)  

    DAYTIME flag 0.0: 27642 values (40.11%)  
    DAYTIME flag 1.0: 23768 values (34.49%)  
    DAYTIME flag 2.0: 13105 values (19.01%)  
    DAYTIME flag missing: 4405 values (6.39%)  

    NIGHTTIME flag 0.0: 18592 values (26.06%)  
    NIGHTTIME flag 1.0: 29635 values (41.54%)  
    NIGHTTIME flag 2.0: 16225 values (22.74%)  
    NIGHTTIME flag missing: 6884 values (9.65%)  

FLAG_L2_FC_SCF_TEST:
    OVERALL flag 0.0: 128947 values (91.94%)  
    OVERALL flag 1.0: 19 values (0.01%)  
    OVERALL flag 2.0: 1 values (0.00%)  
    OVERALL flag missing: 11289 values (8.05%)  

    DAYTIME flag 0.0: 64509 values (93.60%)  
    DAYTIME flag 1.0: 5 values (0.01%)  
    DAYTIME flag 2.0: 1 values (0.00%)  
    DAYTIME flag missing: 4405 values (6.39%)  

    NIGHTTIME flag 0.0: 64438 values (90.33%)  
    NIGHTTIME flag 1.0: 14 values (0.02%)  
    NIGHTTIME flag missing: 6884 values (9.65%)  

FLAG_L2_FC_SIGNAL_STRENGTH_TEST:
    OVERALL flag 0.0: 128903 values (91.91%)  
    OVERALL flag 2.0: 1876 values (1.34%)  
    OVERALL flag missing: 9477 values (6.76%)  

    DAYTIME flag 0.0: 64522 values (93.62%)  
    DAYTIME flag 2.0: 704 values (1.02%)  
    DAYTIME flag missing: 3694 values (5.36%)  

    NIGHTTIME flag 0.0: 64381 values (90.25%)  
    NIGHTTIME flag 2.0: 1172 values (1.64%)  
    NIGHTTIME flag missing: 5783 values (8.11%)  

FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST:
    OVERALL flag 0.0: 132143 values (94.22%)  
    OVERALL flag 2.0: 34 values (0.02%)  
    OVERALL flag missing: 8079 values (5.76%)  

    DAYTIME flag 0.0: 65706 values (95.34%)  
    DAYTIME flag 2.0: 7 values (0.01%)  
    DAYTIME flag missing: 3207 values (4.65%)  

    NIGHTTIME flag 0.0: 66437 values (93.13%)  
    NIGHTTIME flag 2.0: 27 values (0.04%)  
    NIGHTTIME flag missing: 4872 values (6.83%)  

FLAG_L2_FC_CO2_VM97_DROPOUT_TEST:
    OVERALL flag 0.0: 132177 values (94.24%)  
    OVERALL flag missing: 8079 values (5.76%)  

    DAYTIME flag 0.0: 65713 values (95.35%)  
    DAYTIME flag missing: 3207 values (4.65%)  

    NIGHTTIME flag 0.0: 66464 values (93.17%)  
    NIGHTTIME flag missing: 4872 values (6.83%)  

FLAG_L2_FC_QCF:
    OVERALL flag 0.0: 46162 values (32.91%)  
    OVERALL flag 1.0: 23686 values (16.89%)  
    OVERALL flag 2.0: 70408 values (50.20%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 27614 values (40.07%)  
    DAYTIME flag 1.0: 23686 values (34.37%)  
    DAYTIME flag 2.0: 17620 values (25.57%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 18548 values (26.00%)  
    NIGHTTIME flag 2.0: 52788 values (74.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST:
    OVERALL flag 0.0: 139576 values (99.52%)  
    OVERALL flag 2.0: 680 values (0.48%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 68265 values (99.05%)  
    DAYTIME flag 2.0: 655 values (0.95%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 71311 values (99.96%)  
    NIGHTTIME flag 2.0: 25 values (0.04%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST:
    OVERALL flag 0.0: 140256 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 68920 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 71336 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST:
    OVERALL flag 0.0: 138469 values (98.73%)  
    OVERALL flag 2.0: 1787 values (1.27%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 67745 values (98.30%)  
    DAYTIME flag 2.0: 1175 values (1.70%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 70724 values (99.14%)  
    NIGHTTIME flag 2.0: 612 values (0.86%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF:
    OVERALL flag 0.0: 44865 values (31.99%)  
    OVERALL flag 1.0: 22516 values (16.05%)  
    OVERALL flag 2.0: 72875 values (51.96%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 26954 values (39.11%)  
    DAYTIME flag 1.0: 22516 values (32.67%)  
    DAYTIME flag 2.0: 19450 values (28.22%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 17911 values (25.11%)  
    NIGHTTIME flag 2.0: 53425 values (74.89%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.3_CUT_50_NEE_L3.1_USTAR_TEST:
    OVERALL flag 0.0: 97429 values (69.47%)  
    OVERALL flag 2.0: 42827 values (30.53%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 53583 values (77.75%)  
    DAYTIME flag 2.0: 15337 values (22.25%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 43846 values (61.46%)  
    NIGHTTIME flag 2.0: 27490 values (38.54%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.3_CUT_50_NEE_L3.1_QCF:
    OVERALL flag 0.0: 36700 values (26.17%)  
    OVERALL flag 1.0: 16309 values (11.63%)  
    OVERALL flag 2.0: 87247 values (62.21%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 22504 values (32.65%)  
    DAYTIME flag 1.0: 16309 values (23.66%)  
    DAYTIME flag 2.0: 30107 values (43.68%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 14196 values (19.90%)  
    NIGHTTIME flag 2.0: 57140 values (80.10%)  
    NIGHTTIME flag missing: 0 values (0.00%)  


========================================
REPORT: FLAGS FOR AVAILABLE RECORDS
========================================
Stats after removal of missing values
FLAG_L2_FC_MISSING_TEST:
    OVERALL flag 0.0: 128967 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SSITC_TEST:
    OVERALL flag 0.0: 46234 values (35.85%)  
    OVERALL flag 1.0: 53403 values (41.41%)  
    OVERALL flag 2.0: 29330 values (22.74%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 27642 values (42.85%)  
    DAYTIME flag 1.0: 23768 values (36.84%)  
    DAYTIME flag 2.0: 13105 values (20.31%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 18592 values (28.85%)  
    NIGHTTIME flag 1.0: 29635 values (45.98%)  
    NIGHTTIME flag 2.0: 16225 values (25.17%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SCF_TEST:
    OVERALL flag 0.0: 128947 values (99.98%)  
    OVERALL flag 1.0: 19 values (0.01%)  
    OVERALL flag 2.0: 1 values (0.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64509 values (99.99%)  
    DAYTIME flag 1.0: 5 values (0.01%)  
    DAYTIME flag 2.0: 1 values (0.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64438 values (99.98%)  
    NIGHTTIME flag 1.0: 14 values (0.02%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_SIGNAL_STRENGTH_TEST:
    OVERALL flag 0.0: 128382 values (99.55%)  
    OVERALL flag 2.0: 585 values (0.45%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64319 values (99.70%)  
    DAYTIME flag 2.0: 196 values (0.30%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64063 values (99.40%)  
    NIGHTTIME flag 2.0: 389 values (0.60%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST:
    OVERALL flag 0.0: 128934 values (99.97%)  
    OVERALL flag 2.0: 33 values (0.03%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64509 values (99.99%)  
    DAYTIME flag 2.0: 6 values (0.01%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64425 values (99.96%)  
    NIGHTTIME flag 2.0: 27 values (0.04%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_CO2_VM97_DROPOUT_TEST:
    OVERALL flag 0.0: 128967 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L2_FC_QCF:
    OVERALL flag 0.0: 46162 values (35.79%)  
    OVERALL flag 1.0: 23686 values (18.37%)  
    OVERALL flag 2.0: 59119 values (45.84%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 27614 values (42.80%)  
    DAYTIME flag 1.0: 23686 values (36.71%)  
    DAYTIME flag 2.0: 13215 values (20.48%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 18548 values (28.78%)  
    NIGHTTIME flag 2.0: 45904 values (71.22%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST:
    OVERALL flag 0.0: 128287 values (99.47%)  
    OVERALL flag 2.0: 680 values (0.53%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 63860 values (98.98%)  
    DAYTIME flag 2.0: 655 values (1.02%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64427 values (99.96%)  
    NIGHTTIME flag 2.0: 25 values (0.04%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST:
    OVERALL flag 0.0: 128967 values (100.00%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 64515 values (100.00%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 64452 values (100.00%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST:
    OVERALL flag 0.0: 127180 values (98.61%)  
    OVERALL flag 2.0: 1787 values (1.39%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 63340 values (98.18%)  
    DAYTIME flag 2.0: 1175 values (1.82%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 63840 values (99.05%)  
    NIGHTTIME flag 2.0: 612 values (0.95%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.2_NEE_L3.1_QCF:
    OVERALL flag 0.0: 44865 values (34.79%)  
    OVERALL flag 1.0: 22516 values (17.46%)  
    OVERALL flag 2.0: 61586 values (47.75%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 26954 values (41.78%)  
    DAYTIME flag 1.0: 22516 values (34.90%)  
    DAYTIME flag 2.0: 15045 values (23.32%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 17911 values (27.79%)  
    NIGHTTIME flag 2.0: 46541 values (72.21%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.3_CUT_50_NEE_L3.1_USTAR_TEST:
    OVERALL flag 0.0: 86944 values (67.42%)  
    OVERALL flag 2.0: 42023 values (32.58%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 49408 values (76.58%)  
    DAYTIME flag 2.0: 15107 values (23.42%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 37536 values (58.24%)  
    NIGHTTIME flag 2.0: 26916 values (41.76%)  
    NIGHTTIME flag missing: 0 values (0.00%)  

FLAG_L3.3_CUT_50_NEE_L3.1_QCF:
    OVERALL flag 0.0: 36700 values (28.46%)  
    OVERALL flag 1.0: 16309 values (12.65%)  
    OVERALL flag 2.0: 75958 values (58.90%)  
    OVERALL flag missing: 0 values (0.00%)  

    DAYTIME flag 0.0: 22504 values (34.88%)  
    DAYTIME flag 1.0: 16309 values (25.28%)  
    DAYTIME flag 2.0: 25702 values (39.84%)  
    DAYTIME flag missing: 0 values (0.00%)  

    NIGHTTIME flag 0.0: 14196 values (22.03%)  
    NIGHTTIME flag 2.0: 50256 values (77.97%)  
    NIGHTTIME flag missing: 0 values (0.00%)  
</pre></div>
</div>
</div>
</div>
</br></br></section>
</section>
<section id="overview-data-after-level-3-3">
<h2>Overview: data after <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code><a class="headerlink" href="#overview-data-after-level-3-3" title="Link to this heading">#</a></h2>
</section>
<section id="flux-variable-names">
<h2>Flux variable names<a class="headerlink" href="#flux-variable-names" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fluxes_qcf</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_QCF&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;FLAG_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;L3.3&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="n">fluxes_qcf0</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
               <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;_QCF0&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;FLAG_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;L3.3&quot;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quality-controlled fluxes: </span><span class="si">{</span><span class="n">fluxes_qcf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Quality-controlled fluxes, HIGHEST QUALITY: </span><span class="si">{</span><span class="n">fluxes_qcf0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="p">(</span><span class="n">DAYTIME_ACCEPT_QCF_BELOW</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NIGHTTIMETIME_ACCEPT_QCF_BELOW</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="se">\n</span><span class="s2">Note that since only QCF below 1 is accepted for daytime and nighttime data, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;the _QCF and _QCF0 variables are identical.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Quality-controlled fluxes: [&#39;NEE_L3.1_L3.3_CUT_50_QCF&#39;]
Quality-controlled fluxes, HIGHEST QUALITY: [&#39;NEE_L3.1_L3.3_CUT_50_QCF0&#39;]
</pre></div>
</div>
</div>
</div>
</br><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FLUXVAR2QCF</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries_level2_qcf</span><span class="o">.</span><span class="n">name</span>
<span class="n">FLUXVAR31QCF</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries_level31_qcf</span><span class="o">.</span><span class="n">name</span>
<span class="n">FLUXVAR32QCF</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries_level32_qcf</span><span class="o">.</span><span class="n">name</span>
<span class="n">FLUXVAR32QCF_HQ</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR32QCF</span><span class="si">}</span><span class="s2">0&quot;</span>
<span class="n">FLUXVAR33QCF</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">filteredseries_level33_qcf</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OVERVIEW OF FLUX VARIABLES&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR</span><span class="si">}</span><span class="s2"> ... original input flux</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR2QCF</span><span class="si">}</span><span class="s2"> ... flux quality-controlled with Level-2 flags</span><span class="se">\n</span><span class="s2">    --&gt;  not used in any further processing steps</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR31QCF</span><span class="si">}</span><span class="s2"> ... flux quality-controlled with Level-2 flags, including Level-3.1 storage correction</span><span class="se">\n</span><span class="s2">   --&gt;  not used in any further processing steps</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR32QCF</span><span class="si">}</span><span class="s2"> ... flux quality-controlled with Level-2 and Level-3.2 flags, including Level-3.1 storage correction)</span><span class="se">\n</span><span class="s2">    --&gt;  not used in any further processing steps</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR32QCF_HQ</span><span class="si">}</span><span class="s2"> ... highest-quality flux (QCF=0), quality-controlled with Level-2 and Level-3.2 flags, including Level-3.1 storage correction)</span><span class="se">\n</span><span class="s2">    --&gt;  not used in any further processing steps</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Variables for further steps:&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">FLUXVAR33QCF</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">FLUXVAR33QCF</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> ... flux quality-controlled with Level-2 and Level-3.2 flags, and after Level-3.3 USTAR filtering (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">), including Level-3.1 storage correction</span><span class="se">\n</span><span class="s2">--&gt;   to be used in gap-filling and all further steps&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">DAYTIME_ACCEPT_QCF_BELOW</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NIGHTTIMETIME_ACCEPT_QCF_BELOW</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">}</span><span class="se">\n</span><span class="s2">Note that since only QCF below 1 is accepted for daytime and nighttime data, &quot;</span>
          <span class="sa">f</span><span class="s2">&quot;the _QCF and _QCF0 variables are identical.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--------------------------
OVERVIEW OF FLUX VARIABLES
--------------------------
FC ... original input flux
FC_L2_QCF ... flux quality-controlled with Level-2 flags
    --&gt;  not used in any further processing steps
NEE_L3.1_QCF ... flux quality-controlled with Level-2 flags, including Level-3.1 storage correction
   --&gt;  not used in any further processing steps
NEE_L3.1_L3.2_QCF ... flux quality-controlled with Level-2 and Level-3.2 flags, including Level-3.1 storage correction)
    --&gt;  not used in any further processing steps
NEE_L3.1_L3.2_QCF0 ... highest-quality flux (QCF=0), quality-controlled with Level-2 and Level-3.2 flags, including Level-3.1 storage correction)
    --&gt;  not used in any further processing steps

Variables for further steps:
NEE_L3.1_L3.3_CUT_50_QCF ... flux quality-controlled with Level-2 and Level-3.2 flags, and after Level-3.3 USTAR filtering (CUT_50), including Level-3.1 storage correction
--&gt;   to be used in gap-filling and all further steps
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="plot-quality-controlled-flux-after-level-3-3">
<h2>Plot quality-controlled flux after <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code><a class="headerlink" href="#plot-quality-controlled-flux-after-level-3-3" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Plot flux after storage-correction, flux quality control, outlier removal and USTAR filtering</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">FLUXVAR33QCF</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># TimeSeries(series=fpc.fpc_df[fluxhq]).plot_interactive()</span>
    <span class="n">TimeSeries</span><span class="p">(</span><span class="n">series</span><span class="o">=</span><span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">FLUXVAR33QCF</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/b7bdf320915b96c3eb5ca14e62813df292574db00897bb7746717dba52977a28.png" src="../../_images/b7bdf320915b96c3eb5ca14e62813df292574db00897bb7746717dba52977a28.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating a dictionary by passing Series objects as values</span>

<span class="n">frame</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sa">f</span><span class="s1">&#39;original (</span><span class="si">{</span><span class="n">FLUXVAR</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">:</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">FLUXVAR</span><span class="p">],</span>
    <span class="sa">f</span><span class="s1">&#39;+ flux quality flags (</span><span class="si">{</span><span class="n">FLUXVAR2QCF</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">:</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">FLUXVAR2QCF</span><span class="p">],</span>
    <span class="sa">f</span><span class="s1">&#39;++ storage correction (</span><span class="si">{</span><span class="n">FLUXVAR31QCF</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">:</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">FLUXVAR31QCF</span><span class="p">],</span>
    <span class="sa">f</span><span class="s1">&#39;+++ outlier removal (</span><span class="si">{</span><span class="n">FLUXVAR32QCF</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">:</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">FLUXVAR32QCF</span><span class="p">]</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">FLUXVAR33QCF</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">frame</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;+++ USTAR filtering (</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">FLUXVAR33QCF</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FLUXVAR33QCF</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<span class="n">overview</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<span class="n">overview</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cumulative&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">x_compat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/c138c42f5668eb2390e73d48ea2765407063a9a5a2cfa1df14c3a4923455841e.png" src="../../_images/c138c42f5668eb2390e73d48ea2765407063a9a5a2cfa1df14c3a4923455841e.png" />
</div>
</div>
</br></br></section>
<section id="available-level-3-3-fluxes">
<h2>Available <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code> fluxes<a class="headerlink" href="#available-level-3-3-fluxes" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_fluxcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
             <span class="s1">&#39;L3.1&#39;</span> <span class="ow">and</span> <span class="s1">&#39;L3.3&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_QCF&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;FLAG_&#39;</span><span class="p">)]</span>
<span class="n">_fluxcols</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;NEE_L3.1_L3.3_CUT_50_QCF&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_subset</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">[</span><span class="n">_fluxcols</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">_subset</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NEE_L3.1_L3.3_CUT_50_QCF</th>
    </tr>
    <tr>
      <th>TIMESTAMP_MIDDLE</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01 00:15:00</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2017-01-01 00:45:00</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2017-01-01 01:15:00</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2017-01-01 01:45:00</th>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2017-01-01 02:15:00</th>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_subset</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">x_compat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Available Level-3.3 fluxes after application of all quality checks&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/a149f8da77a6300055dd4b948098091d40ede23e0fba41bd56ef1745b710a181.png" src="../../_images/a149f8da77a6300055dd4b948098091d40ede23e0fba41bd56ef1745b710a181.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Draw boxplots</span>
<span class="c1"># for _f in _fluxcols:</span>
<span class="c1">#     boxplots_df = fpc.fpc_df[[_f, &quot;DAYTIME&quot;]].copy()</span>
<span class="c1">#     boxplots_df[&quot;MONTH&quot;] = boxplots_df.index.month</span>
<span class="c1">#     sns.set_theme(style=&quot;ticks&quot;, palette=&quot;pastel&quot;)</span>
<span class="c1">#     plt.figure(figsize=(12, 3))</span>
<span class="c1">#     sns.boxplot(x=&quot;MONTH&quot;, y=_f, palette=[&quot;r&quot;, &quot;b&quot;], hue=&quot;DAYTIME&quot;, data=boxplots_df).set_title(f&quot;Boxplot of {_f}&quot;)</span>
<span class="c1">#     sns.despine(offset=10, trim=True)</span>
<span class="c1">#     plt.axhline(0, color=&quot;black&quot;);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Draw a nested violinplot and split the violins for easier comparison</span>
<span class="c1"># for _f in _fluxcols:</span>
<span class="c1">#     plt.figure(figsize=(20, 2))</span>
<span class="c1">#     sns.violinplot(data=boxplots_df, x=&quot;MONTH&quot;, y=fpc.fpc_df[_f], hue=&quot;DAYTIME&quot;, split=True, palette=[&quot;r&quot;, &quot;b&quot;], gap=.1,</span>
<span class="c1">#                    inner=&quot;quart&quot;)</span>
<span class="c1">#     plt.axhline(0, color=&quot;black&quot;)</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="save-level-3-3-results-to-file">
<h2>Save Level-3.3 results to file<a class="headerlink" href="#save-level-3-3-results-to-file" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>If needed, save results so far (input data and all created variables, e.g. flags and filtered fluxes) to a file</p></li>
<li><p>This can be useful if e.g. gap-filling should be done elsewhere (ReddyProc…)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # results_df = fpc.get_data()</span>
<span class="c1"># out_df = fpc.fpc_df.copy()</span>
<span class="c1"># filename = &quot;32.2_FluxProcessingChain_L3.3_NEE-results&quot;</span>
<span class="c1"># out_df.to_csv(f&quot;{filename}.csv&quot;, index=True)</span>
<span class="c1"># save_parquet(data=out_df, filename=filename)</span>
</pre></div>
</div>
</div>
</div>
</br></br></section>
<section id="export-for-mds-gap-filling-in-reddyproc">
<h2>Export for MDS gap-filling in REddyProc<a class="headerlink" href="#export-for-mds-gap-filling-in-reddyproc" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># from diive.core.times.times import insert_timestamp</span>
<span class="c1"># export = results_df.copy()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># exportcols = [&#39;NEE_L3.1_L3.3_CUT_16_QCF&#39;, &#39;NEE_L3.1_L3.3_CUT_50_QCF&#39;, &#39;NEE_L3.1_L3.3_CUT_84_QCF&#39;,</span>
<span class="c1">#               &#39;SW_IN_T1_2_1&#39;, &#39;TA_T1_2_1&#39;, &#39;VPD_T1_2_1&#39;]</span>
<span class="c1"># export = export[exportcols].copy()</span>
<span class="c1"># locs = (export.index.year &gt;= 2005) &amp; (export.index.year &lt;= 2023)</span>
<span class="c1"># export = export[locs].copy()</span>
<span class="c1"># export = insert_timestamp(data=export, convention=&quot;end&quot;, set_as_index=True)</span>
<span class="c1"># export</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># filename = &quot;32.3_FluxProcessingChain_L3.3_NEE-subset-forREddyProc&quot;</span>
<span class="c1"># export.to_csv(f&quot;{filename}.csv&quot;, index=True)</span>
<span class="c1"># save_parquet(data=export, filename=filename)</span>
</pre></div>
</div>
</div>
</div>
</br></section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="level-4-1-gap-filling">
<h1>Level-4.1: <strong>GAP-FILLING</strong><a class="headerlink" href="#level-4-1-gap-filling" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>Introduced in <code class="docutils literal notranslate"><span class="pre">diive</span></code> v0.85.0, gap-filling can now be done using both random forest and MDS</p></li>
<li><p>For gap-filling using MDS, make sure that variables are in the required units: short-wave incoming radiation in <code class="docutils literal notranslate"><span class="pre">W</span> <span class="pre">m-2</span></code>, air temperature in <code class="docutils literal notranslate"><span class="pre">°C</span></code>, VPD in <code class="docutils literal notranslate"><span class="pre">hPa</span></code></p></li>
</ul>
<p>Parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mds_settings</span></code> are parameters for the MDS gap-filling method, <a class="reference external" href="https://github.com/holukas/diive/blob/main/diive/pkgs/gapfilling/mds.py">see docstring here for more details</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rf_settings</span></code> are parameters for scikit’s <code class="docutils literal notranslate"><span class="pre">RandomForestRegressor</span></code> model, <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">see their official documentation for allowed parameters</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ml_feature_settings</span></code> are general settings for machine-learning models (such as random forest)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SW_IN_T1_47_1_gfXG&quot;</span><span class="p">,</span> <span class="s2">&quot;TA_T1_47_1_gfXG&quot;</span><span class="p">,</span> <span class="s2">&quot;VPD_T1_47_1_gfXG&quot;</span><span class="p">]</span>

<span class="n">fpc</span><span class="o">.</span><span class="n">level41_gapfilling_longterm</span><span class="p">(</span>
    <span class="n">run_mds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">run_random_forest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ml_feature_settings</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;features&#39;</span><span class="p">:</span> <span class="n">FEATURES</span><span class="p">,</span>
        <span class="s1">&#39;features_lag&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
        <span class="s1">&#39;features_lag_exclude_cols&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;reduce_features&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;include_timestamp_as_features&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;add_continuous_record_number&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;perm_n_repeats&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="n">rf_settings</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;n_jobs&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">},</span>
    <span class="n">mds_settings</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;swin&#39;</span><span class="p">:</span> <span class="s2">&quot;SW_IN_T1_47_1_gfXG&quot;</span><span class="p">,</span>
        <span class="s1">&#39;ta&#39;</span><span class="p">:</span> <span class="s2">&quot;TA_T1_47_1_gfXG&quot;</span><span class="p">,</span>
        <span class="s1">&#39;vpd&#39;</span><span class="p">:</span> <span class="s2">&quot;VPD_T1_47_1_gfXG&quot;</span><span class="p">,</span>
        <span class="s1">&#39;swin_tol&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span>
        <span class="s1">&#39;ta_tol&#39;</span><span class="p">:</span> <span class="mf">2.5</span><span class="p">,</span>
        <span class="s1">&#39;vpd_tol&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;avg_min_n_vals&#39;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>==============================
Starting MDS gap-filling of flux NEE_L3.1_L3.3_CUT_50_QCF.
MDS gap-filling quality 1    using SW_IN, TA, VPD in 7 days window ...
MDS gap-filling quality 2    using SW_IN, TA, VPD in 14 days window ...
MDS gap-filling quality 3    using SW_IN in 7 days window ...
MDS gap-filling quality 4    using mean diurnal cycle of flux in 0 days, 1 hours window ...
MDS gap-filling quality 5    using mean diurnal cycle of flux in 1 days, 1 hours window ...
MDS gap-filling quality 6    using SW_IN, TA, VPD in 21 days window ...
MDS gap-filling quality 7    using SW_IN, TA, VPD in 28 days window ...
MDS gap-filling quality 8    using SW_IN in 14 days window ...
MDS gap-filling quality 9    using SW_IN, TA, VPD in 35 days window ...
MDS gap-filling quality 10    using SW_IN, TA, VPD in 42 days window ...
MDS gap-filling quality 11    using SW_IN, TA, VPD in 49 days window ...
MDS gap-filling quality 12    using SW_IN, TA, VPD in 56 days window ...
MDS gap-filling quality 13    using SW_IN, TA, VPD in 63 days window ...
MDS gap-filling quality 14    using SW_IN, TA, VPD in 70 days window ...
MDS gap-filling quality 15    using SW_IN, TA, VPD in 77 days window ...
MDS gap-filling quality 16    using SW_IN, TA, VPD in 84 days window ...
MDS gap-filling quality 17    using SW_IN, TA, VPD in 91 days window ...
MDS gap-filling quality 18    using SW_IN, TA, VPD in 98 days window ...
MDS gap-filling quality 19    using SW_IN, TA, VPD in 105 days window ...
MDS gap-filling quality 20    using SW_IN, TA, VPD in 112 days window ...
MDS gap-filling quality 21    using SW_IN, TA, VPD in 119 days window ...
MDS gap-filling quality 22    using SW_IN, TA, VPD in 126 days window ...
MDS gap-filling quality 23    using SW_IN, TA, VPD in 133 days window ...
MDS gap-filling quality 24    using SW_IN, TA, VPD in 140 days window ...
MDS gap-filling quality 25    using SW_IN in 21 days window ...
MDS gap-filling quality 26    using SW_IN in 28 days window ...
MDS gap-filling quality 27    using SW_IN in 35 days window ...
MDS gap-filling quality 28    using SW_IN in 42 days window ...
MDS gap-filling quality 29    using SW_IN in 49 days window ...
MDS gap-filling quality 30    using SW_IN in 56 days window ...
MDS gap-filling quality 31    using SW_IN in 63 days window ...
MDS gap-filling quality 32    using SW_IN in 70 days window ...
MDS gap-filling quality 33    using SW_IN in 77 days window ...
MDS gap-filling quality 34    using SW_IN in 84 days window ...
MDS gap-filling quality 35    using SW_IN in 91 days window ...
MDS gap-filling quality 36    using SW_IN in 98 days window ...
MDS gap-filling quality 37    using SW_IN in 105 days window ...
MDS gap-filling quality 38    using SW_IN in 112 days window ...
MDS gap-filling quality 39    using SW_IN in 119 days window ...
MDS gap-filling quality 40    using SW_IN in 126 days window ...
MDS gap-filling quality 41    using SW_IN in 133 days window ...
MDS gap-filling quality 42    using SW_IN in 140 days window ...
MDS gap-filling quality 43    using mean diurnal cycle of flux in 21 days, 1 hours window ...
MDS gap-filling done.
</pre></div>
</div>
</div>
</div>
<section id="get-results">
<h2>Get results<a class="headerlink" href="#get-results" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Results from the flux processing chain can be accessed using <code class="docutils literal notranslate"><span class="pre">.get_data()</span></code></p></li>
<li><p>This returns a dataframe containing all input data and all newly generated variables, such as quality flags, quality-filtered fluxes and gap-filled fluxes</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NEW VARIABLES FROM FLUX PROCESSING CHAIN:
++ FLAG_L2_FC_MISSING_TEST
++ FLAG_L2_FC_SSITC_TEST
++ FLAG_L2_FC_SCF_TEST
++ FLAG_L2_FC_SIGNAL_STRENGTH_TEST
++ FLAG_L2_FC_CO2_VM97_SPIKE_HF_TEST
++ FLAG_L2_FC_CO2_VM97_DROPOUT_TEST
++ SUM_L2_FC_HARDFLAGS
++ SUM_L2_FC_SOFTFLAGS
++ SUM_L2_FC_FLAGS
++ FLAG_L2_FC_QCF
++ FC_L2_QCF
++ FC_L2_QCF0
++ SC_SINGLE_gfRMED_L3.1
++ FLAG_SC_SINGLE_gfRMED_L3.1_ISFILLED
++ NEE_L3.1
++ NEE_L3.1_QCF
++ NEE_L3.1_QCF0
++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_ABSLIM_TEST
++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_MANUAL_TEST
++ FLAG_L3.2_NEE_L3.1_QCF_OUTLIER_HAMPELDTNT_TEST
++ SUM_L3.2_NEE_L3.1_HARDFLAGS
++ SUM_L3.2_NEE_L3.1_SOFTFLAGS
++ SUM_L3.2_NEE_L3.1_FLAGS
++ FLAG_L3.2_NEE_L3.1_QCF
++ NEE_L3.1_L3.2_QCF
++ NEE_L3.1_L3.2_QCF0
++ FLAG_L3.3_CUT_50_NEE_L3.1_USTAR_TEST
++ SUM_L3.3_CUT_50_NEE_L3.1_HARDFLAGS
++ SUM_L3.3_CUT_50_NEE_L3.1_SOFTFLAGS
++ SUM_L3.3_CUT_50_NEE_L3.1_FLAGS
++ FLAG_L3.3_CUT_50_NEE_L3.1_QCF
++ NEE_L3.1_L3.3_CUT_50_QCF
++ NEE_L3.1_L3.3_CUT_50_QCF0
++ NEE_L3.1_L3.3_CUT_50_QCF_gfMDS
++ FLAG_NEE_L3.1_L3.3_CUT_50_QCF_gfMDS_ISFILLED
No variables in input data were overwritten, only new variables added.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AIR_CP</th>
      <th>AIR_DENSITY</th>
      <th>AIR_MV</th>
      <th>AIR_RHO_CP</th>
      <th>AOA_METHOD</th>
      <th>AXES_ROTATION_METHOD</th>
      <th>...</th>
      <th>SUM_L3.3_CUT_50_NEE_L3.1_FLAGS</th>
      <th>FLAG_L3.3_CUT_50_NEE_L3.1_QCF</th>
      <th>NEE_L3.1_L3.3_CUT_50_QCF</th>
      <th>NEE_L3.1_L3.3_CUT_50_QCF0</th>
      <th>NEE_L3.1_L3.3_CUT_50_QCF_gfMDS</th>
      <th>FLAG_NEE_L3.1_L3.3_CUT_50_QCF_gfMDS_ISFILLED</th>
    </tr>
    <tr>
      <th>TIMESTAMP_MIDDLE</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01 00:15:00</th>
      <td>1007.20</td>
      <td>1.16100</td>
      <td>0.024942</td>
      <td>1169.36</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.754945</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 00:45:00</th>
      <td>1007.18</td>
      <td>1.16086</td>
      <td>0.024945</td>
      <td>1169.19</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.754945</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 01:15:00</th>
      <td>1007.12</td>
      <td>1.16529</td>
      <td>0.024851</td>
      <td>1173.58</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.714970</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 01:45:00</th>
      <td>1007.07</td>
      <td>1.16261</td>
      <td>0.024908</td>
      <td>1170.83</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>4.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.729187</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2017-01-01 02:15:00</th>
      <td>1007.14</td>
      <td>1.16261</td>
      <td>0.024908</td>
      <td>1170.92</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.714970</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2024-12-31 21:45:00</th>
      <td>1007.71</td>
      <td>1.14956</td>
      <td>0.025189</td>
      <td>1158.42</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>3.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.957790</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 22:15:00</th>
      <td>1007.74</td>
      <td>1.14940</td>
      <td>0.025193</td>
      <td>1158.31</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>2.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.388479</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 22:45:00</th>
      <td>1007.82</td>
      <td>1.14946</td>
      <td>0.025191</td>
      <td>1158.44</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.192741</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 23:15:00</th>
      <td>1007.71</td>
      <td>1.14668</td>
      <td>0.025253</td>
      <td>1155.52</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>6.083228</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2024-12-31 23:45:00</th>
      <td>1007.78</td>
      <td>1.15011</td>
      <td>0.025177</td>
      <td>1159.05</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>2.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.192741</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>140256 rows × 544 columns</p>
</div></div></div>
</div>
</section>
<section id="model-scores">
<h2>Model scores<a class="headerlink" href="#model-scores" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">report_gapfilling_model_scores</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MODEL SCORES (mds): CUT_50
                                           0
mae                                 4.119450
medae                               2.614410
mse                                39.015495
rmse                                6.246238
mape                                4.652787
maxe                               53.740639
r2                                  0.660592
mean_quality_flag_gap_predictions   1.582920
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">report_gapfilling_feature_importances</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mds CUT_50 does not have feature importances.
</pre></div>
</div>
</div>
</div>
<p>During long-term gap-filling, different years are pooled together to predict one central year, i.e., multiple models are used.<br />
The used data pools can be display with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">report_gapfilling_poolyears</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DATA POOLS USED FOR MACHINE-LEARNING GAP-FILLING:
mds CUT_50 did not use poolyears.
</pre></div>
</div>
</div>
</div>
</section>
<section id="names-of-gap-filled-variables">
<h2>Names of gap-filled variables<a class="headerlink" href="#names-of-gap-filled-variables" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Used model, USTAR scenario, non-gapfilled variable and gap-filled variable:&quot;</span><span class="p">)</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">report_gapfilling_variables</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Used model, USTAR scenario, non-gapfilled variable and gap-filled variable:
mds (CUT_50): NEE_L3.1_L3.3_CUT_50_QCF -&gt; NEE_L3.1_L3.3_CUT_50_QCF_gfMDS
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gapfilled_names</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">get_gapfilled_names</span><span class="p">()</span>
<span class="n">gapfilled_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;NEE_L3.1_L3.3_CUT_50_QCF_gfMDS&#39;]
</pre></div>
</div>
</div>
</div>
<p>Gap-filled data can also be accessed directly. To get all gap-filled variables and also the same variables before gap-filling in a dataframe, use <code class="docutils literal notranslate"><span class="pre">.get_gapfilled_variables()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gapfilled_vars</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">get_gapfilled_variables</span><span class="p">()</span>
<span class="n">gapfilled_vars</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NEE_L3.1_L3.3_CUT_50_QCF_gfMDS</th>
      <th>NEE_L3.1_L3.3_CUT_50_QCF</th>
    </tr>
    <tr>
      <th>TIMESTAMP_MIDDLE</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01 00:15:00</th>
      <td>1.754945</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2017-01-01 00:45:00</th>
      <td>1.754945</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2017-01-01 01:15:00</th>
      <td>1.714970</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The names of the flux that was gap-filled can be accessed like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nongapfilled_names</span> <span class="o">=</span> <span class="n">fpc</span><span class="o">.</span><span class="n">get_nongapfilled_names</span><span class="p">()</span>
<span class="n">nongapfilled_names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;NEE_L3.1_L3.3_CUT_50_QCF&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section id="plot-gap-filled-heatmaps">
<h2>Plot: gap-filled heatmaps<a class="headerlink" href="#plot-gap-filled-heatmaps" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">showplot_gapfilled_heatmap</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/1db51b2cf8e4524eea5051e8a2c6db37731ab9b06396e51af5d703587c90c918.png" src="../../_images/1db51b2cf8e4524eea5051e8a2c6db37731ab9b06396e51af5d703587c90c918.png" />
</div>
</div>
</section>
<section id="plot-gap-filled-cumulatives-per-year">
<h2>Plot: Gap-filled cumulatives per year<a class="headerlink" href="#plot-gap-filled-cumulatives-per-year" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">showplot_gapfilled_cumulative</span><span class="p">(</span><span class="n">gain</span><span class="o">=</span><span class="mf">0.02161926</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;($\mathrm{gC\ m^{-2}}$)&#39;</span><span class="p">,</span> <span class="n">per_year</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/66a301ac9fae31937c729c4f6bf9d39f36f4b76cac69cd4f690d944bb5c57c1d.png" src="../../_images/66a301ac9fae31937c729c4f6bf9d39f36f4b76cac69cd4f690d944bb5c57c1d.png" />
</div>
</div>
</section>
<section id="plot-gap-filled-cumulative-across-all-data">
<h2>Plot: gap-filled cumulative across all data<a class="headerlink" href="#plot-gap-filled-cumulative-across-all-data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">showplot_gapfilled_cumulative</span><span class="p">(</span><span class="n">gain</span><span class="o">=</span><span class="mf">0.02161926</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;($\mathrm{gC\ m^{-2}}$)&#39;</span><span class="p">,</span> <span class="n">per_year</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7a39076faa25728d92b2d0d717d94f75124d404b7aa09f1e8aa013b7058638af.png" src="../../_images/7a39076faa25728d92b2d0d717d94f75124d404b7aa09f1e8aa013b7058638af.png" />
</div>
</div>
</section>
<section id="plot-model-feature-ranks-per-year">
<h2>Plot: model feature ranks per year<a class="headerlink" href="#plot-model-feature-ranks-per-year" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fpc</span><span class="o">.</span><span class="n">showplot_feature_ranks_per_year</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>mds CUT_50 does not have feature ranks.
</pre></div>
</div>
</div>
</div>
</br></br></section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="save-results-to-file">
<h1>Save results to file<a class="headerlink" href="#save-results-to-file" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<ul class="simple">
<li><p>Save results to file for futher processing</p></li>
<li><p>This can be useful if you want to use the data in another software, e.g. continuing post-processing using the library <code class="docutils literal notranslate"><span class="pre">ReddyProc</span></code> in <code class="docutils literal notranslate"><span class="pre">R</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Parquet</span></code> format is recommended for large datasets</p></li>
</ul>
</br><div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;NEE&quot;</span>
</pre></div>
</div>
</div>
</div>
</br><section id="option-1-save-complete-data-input-data-and-results">
<h2>Option 1: Save complete data (input data and results)<a class="headerlink" href="#option-1-save-complete-data-input-data-and-results" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># outfile = f&quot;FluxProcessingChain_L4.1_complete_{suffix}&quot;</span>
<span class="c1"># results.to_csv(f&quot;{outfile}.csv&quot;)  # large file, slow to read</span>
<span class="c1"># save_parquet(data=results, filename=f&quot;{outfile}&quot;)  # Smaller file, very fast to read</span>
</pre></div>
</div>
</div>
</div>
</br></section>
<section id="option-2-save-flux-processing-chain-results-without-input-data">
<h2>Option 2: Save flux processing chain results (without input data)<a class="headerlink" href="#option-2-save-flux-processing-chain-results-without-input-data" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Needed if you want to continue post-processing in notebooks</p></li>
<li><p>Can also be used in <code class="docutils literal notranslate"><span class="pre">R</span></code> with the <code class="docutils literal notranslate"><span class="pre">arrow</span></code> package</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;09.2_L0_FluxProcessingChain_L4.1_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>  <span class="c1"># large file, slow to read</span>
<span class="n">save_parquet</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">fpc</span><span class="o">.</span><span class="n">fpc_df</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Smaller file, very fast to read</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saved file 09.2_L0_FluxProcessingChain_L4.1_NEE.parquet (0.168 seconds).
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;09.2_L0_FluxProcessingChain_L4.1_NEE.parquet&#39;
</pre></div>
</div>
</div>
</div>
</br></br></section>
</section>
<hr class="docutils" />
<section class="tex2jax_ignore mathjax_ignore" id="end-of-notebook">
<h1><strong>End of notebook</strong><a class="headerlink" href="#end-of-notebook" title="Link to this heading">#</a></h1>
<hr class="docutils" />
<p>Congratulations, you reached the end of this notebook! Before you go let’s store your finish time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dt_string</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished. </span><span class="si">{</span><span class="n">dt_string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Finished. 2025-06-12 11:41:13
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks\00_L0_checks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#"><strong>BACKGROUND</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#general-settings"><strong>GENERAL SETTINGS</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-variable">Flux variable</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#site-location">Site location</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#daytime-nighttime">Daytime/nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quality-requirements">Quality requirements</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#imports"><strong>IMPORTS</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#docstring-for-fluxprocessingchain"><strong>DOCSTRING</strong> for <code class="docutils literal notranslate"><span class="pre">FluxProcessingChain</span></code></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-2-options"><strong>LOAD DATA</strong> (2 options)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-load-data-from-single-or-multiple-eddypro-fluxnet-output-files">Option 1: Load data from single or multiple EddyPro <em><em>fluxnet</em></em> output files</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-load-data-from-parquet-file">Option 2: Load data from <code class="docutils literal notranslate"><span class="pre">parquet</span></code> file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-3-load-example-data">Option 3: Load example data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-restrict-data-to-time-range">(Optional) Restrict data to time range</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#check-data">Check data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#start-flux-processing-chain"><strong>START FLUX PROCESSING CHAIN</strong></a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-quality-flag-extension">Level-2: <strong>QUALITY FLAG EXTENSION</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#user-settings">User settings</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ssitc-tests-default-true">SSITC tests (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-base-variable-completeness-test-default-true">Flux base variable completeness test (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spectral-correction-factor-test-default-true">Spectral correction factor test (default: <code class="docutils literal notranslate"><span class="pre">True</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#signal-strength-test">Signal strength test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#raw-data-screening-tests">Raw data screening tests</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#angle-of-attack-test-default-false">Angle-of-attack test (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steadiness-of-horizontal-wind-test-default-false">Steadiness of horizontal wind test (default: <code class="docutils literal notranslate"><span class="pre">False</span></code>)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run">Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-2">Finalize Level-2</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-2-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-2</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plots">Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reports">Reports</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-1-storage-correction">Level-3.1: <strong>STORAGE CORRECTION</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Run</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-3-1"><strong>Finalize Level-3.1</strong></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-1-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-3.1</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Plots</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#report">Report</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#optional-analyze-highest-quality-flux-so-far">Optional: <strong>Analyze highest-quality flux</strong> (so far)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-2-outlier-detection">Level-3.2: <strong>OUTLIER DETECTION</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-time-series">Plot time series</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initiate-calculations">Initiate calculations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-absolute-limits">Outlier flag: <strong>Absolute limits</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-manual-flag">Outlier flag: <strong>Manual flag</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-hampel-filter-separate-for-daytime-and-nighttime">Outlier flag: <strong>Hampel filter</strong>, separate for daytime and nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-z-score-across-all-data">Outlier flag: <strong>z-score across all data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-hampel-filter">Outlier flag: <strong>Hampel filter</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-z-score-over-all-data-separate-for-daytime-and-nighttime">Outlier flag: <strong>z-score over all data</strong>, separate for daytime and nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-rolling-z-score-over-all-data">Outlier flag: <strong>Rolling z-score over all data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-standard-deviation-with-rolling-median-and-rolling-standard-deviation">Outlier flag: <strong>Local standard deviation</strong>, with rolling median and <em>rolling</em> standard deviation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-standard-deviation-with-rolling-median-and-constant-standard-deviation">Outlier flag: <strong>Local standard deviation</strong>, with rolling median and <em>constant</em> standard deviation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-increments-z-score">Outlier flag: <strong>Increments z-score</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-outlier-factor-daytime-nighttime">Outlier flag: <strong>Local outlier factor</strong>, daytime/nighttime</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-local-outlier-factor">Outlier flag: <strong>Local outlier factor</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-absolute-limits-separate-for-daytime-and-nighttime-data">Outlier flag: <strong>Absolute limits</strong>, separate for daytime and nighttime data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#outlier-flag-trim-nighttime-flux-data">Outlier flag: <strong>Trim nighttime flux data</strong></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-3-2-calculate-overall-quality-flag-so-far"><strong>Finalize Level-3.2</strong>: Calculate overall quality flag (so far)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-2-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-3.2</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-filtered-flux-after-level-3-2">Plot filtered flux after Level-3.2</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Reports</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-level-3-2-results-to-file">Save Level-3.2 results to file</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-3-3-ustar-filtering">Level-3.3: <strong>USTAR FILTERING</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finalize-level-3-3-caculate-overall-final-quality-flag"><strong>Finalize Level-3.3</strong>: Caculate overall final quality flag</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-3-variables">Available <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code> variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-filtered-flux-after-level-3-3">Plot filtered flux after Level-3.3</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Reports</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview-data-after-level-3-3">Overview: data after <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flux-variable-names">Flux variable names</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-quality-controlled-flux-after-level-3-3">Plot quality-controlled flux after <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#available-level-3-3-fluxes">Available <code class="docutils literal notranslate"><span class="pre">Level-3.3</span></code> fluxes</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#save-level-3-3-results-to-file">Save Level-3.3 results to file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#export-for-mds-gap-filling-in-reddyproc">Export for MDS gap-filling in REddyProc</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#level-4-1-gap-filling">Level-4.1: <strong>GAP-FILLING</strong></a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#get-results">Get results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-scores">Model scores</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#names-of-gap-filled-variables">Names of gap-filled variables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-gap-filled-heatmaps">Plot: gap-filled heatmaps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-gap-filled-cumulatives-per-year">Plot: Gap-filled cumulatives per year</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-gap-filled-cumulative-across-all-data">Plot: gap-filled cumulative across all data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#plot-model-feature-ranks-per-year">Plot: model feature ranks per year</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#save-results-to-file">Save results to file</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-1-save-complete-data-input-data-and-results">Option 1: Save complete data (input data and results)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#option-2-save-flux-processing-chain-results-without-input-data">Option 2: Save flux processing chain results (without input data)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#end-of-notebook"><strong>End of notebook</strong></a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Lukas Hörtnagl
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>